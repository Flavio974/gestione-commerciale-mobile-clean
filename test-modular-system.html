<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Test Sistema Modulare DDTFT</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 1200px; 
            margin: 20px auto; 
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section { 
            background: white; 
            padding: 20px; 
            margin: 20px 0; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .warning { color: #ffc107; font-weight: bold; }
        .info { color: #17a2b8; font-weight: bold; }
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .log { 
            background: #f8f9fa; 
            border: 1px solid #dee2e6; 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 4px; 
            font-family: monospace; 
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        #status { 
            padding: 10px; 
            border-radius: 4px; 
            margin: 10px 0; 
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>üß™ Test Sistema Modulare DDTFT</h1>
    <p class="info">‚ö†Ô∏è Questo test √® COMPLETAMENTE SICURO - non modifica nulla del sistema originale!</p>

    <div id="status" class="warning">üîÑ Caricamento in corso...</div>

    <div class="test-section">
        <h2>üì¶ 1. Test Caricamento Moduli</h2>
        <button onclick="testModuleLoading()">‚ñ∂Ô∏è Testa Caricamento</button>
        <div id="module-log" class="log"></div>
    </div>

    <div class="test-section">
        <h2>üîß 2. Test Compatibilit√† API</h2>
        <button onclick="testAPICompatibility()">‚ñ∂Ô∏è Testa API</button>
        <div id="api-log" class="log"></div>
    </div>

    <div class="test-section">
        <h2>üìÑ 3. Test Funzioni PDF</h2>
        <button onclick="testPDFFunctions()">‚ñ∂Ô∏è Testa PDF</button>
        <div id="pdf-log" class="log"></div>
    </div>

    <div class="test-section">
        <h2>üéõÔ∏è 4. Test Sistema di Fallback</h2>
        <button onclick="testFallbackSystem()">‚ñ∂Ô∏è Testa Fallback</button>
        <div id="fallback-log" class="log"></div>
    </div>

    <div class="test-section">
        <h2>üìä 5. Confronto Performance</h2>
        <button onclick="testPerformance()">‚ñ∂Ô∏è Testa Performance</button>
        <div id="performance-log" class="log"></div>
    </div>

    <script>
        let moduleSystem = null;
        let originalSystem = null;

        // Carica sistema originale per confronto
        async function loadOriginalSystem() {
            try {
                // Simula il caricamento del sistema originale
                const script = document.createElement('script');
                script.src = 'js/ddtft-import.js';
                document.head.appendChild(script);
                
                return new Promise((resolve) => {
                    script.onload = () => {
                        originalSystem = window.DDTFTImport;
                        resolve(true);
                    };
                    script.onerror = () => resolve(false);
                });
            } catch (error) {
                console.error('Errore caricamento sistema originale:', error);
                return false;
            }
        }

        // Test caricamento moduli
        async function testModuleLoading() {
            const log = document.getElementById('module-log');
            log.textContent = '';
            
            try {
                log.textContent += 'üîÑ Caricamento sistema modulare...\n';
                
                // Prova a caricare il sistema modulare
                const { DDTFTImport } = await import('./js/ddtft-import/ddtft-import-core.js');
                moduleSystem = DDTFTImport;
                
                log.textContent += '‚úÖ Sistema modulare caricato con successo!\n';
                log.textContent += `üì¶ Funzioni disponibili: ${Object.keys(DDTFTImport).length}\n`;
                log.textContent += 'üìã Funzioni principali:\n';
                
                Object.keys(DDTFTImport).slice(0, 10).forEach(key => {
                    log.textContent += `  - ${key}\n`;
                });
                
                updateStatus('‚úÖ Sistema modulare FUNZIONA!', 'success');
                
            } catch (error) {
                log.textContent += `‚ùå Errore: ${error.message}\n`;
                log.textContent += 'üîÑ Tentativo fallback al sistema originale...\n';
                
                const originalLoaded = await loadOriginalSystem();
                if (originalLoaded) {
                    log.textContent += '‚úÖ Fallback al sistema originale riuscito!\n';
                    updateStatus('‚ö†Ô∏è Sistema modulare fallito, ma fallback OK', 'warning');
                } else {
                    log.textContent += '‚ùå Anche il fallback √® fallito!\n';
                    updateStatus('‚ùå Sistema modulare e fallback falliti', 'error');
                }
            }
        }

        // Test compatibilit√† API
        async function testAPICompatibility() {
            const log = document.getElementById('api-log');
            log.textContent = '';
            
            if (!moduleSystem) {
                log.textContent += '‚ùå Sistema modulare non caricato\n';
                return;
            }
            
            // Lista delle funzioni che devono esistere
            const requiredFunctions = [
                'extractTextFromPdf',
                'parseDocumentFromText',
                'extractDocumentNumber',
                'extractDate',
                'extractClientName',
                'extractVatNumber',
                'extractDeliveryAddress',
                'generateId',
                'validateDeliveryAddress',
                'exportDocumentsToExcel'
            ];
            
            log.textContent += 'üîç Verifico compatibilit√† API...\n\n';
            
            let passed = 0;
            requiredFunctions.forEach(funcName => {
                if (typeof moduleSystem[funcName] === 'function') {
                    log.textContent += `‚úÖ ${funcName}: OK\n`;
                    passed++;
                } else {
                    log.textContent += `‚ùå ${funcName}: MANCANTE\n`;
                }
            });
            
            log.textContent += `\nüìä Risultato: ${passed}/${requiredFunctions.length} funzioni presenti\n`;
            
            if (passed === requiredFunctions.length) {
                log.textContent += '‚úÖ Compatibilit√† API: PERFETTA!\n';
            } else {
                log.textContent += '‚ö†Ô∏è Compatibilit√† API: PARZIALE\n';
            }
        }

        // Test funzioni PDF
        async function testPDFFunctions() {
            const log = document.getElementById('pdf-log');
            log.textContent = '';
            
            if (!moduleSystem) {
                log.textContent += '‚ùå Sistema modulare non caricato\n';
                return;
            }
            
            log.textContent += 'üìÑ Test funzioni PDF...\n\n';
            
            // Test con dati mock
            try {
                // Test generateId
                const id1 = moduleSystem.generateId();
                const id2 = moduleSystem.generateId();
                log.textContent += `‚úÖ generateId(): ${id1}\n`;
                log.textContent += `‚úÖ generateId(): ${id2}\n`;
                log.textContent += `‚úÖ ID unici: ${id1 !== id2 ? 'S√å' : 'NO'}\n\n`;
                
                // Test validateDeliveryAddress
                const testAddresses = [
                    'VIA ROMA 123 10100 TORINO TO',
                    'CORSO MARCONI 10/E 12050 MAGLIANO ALFIERI CN', // Dovrebbe essere rifiutato
                    'PIAZZA GARIBALDI 5 20100 MILANO MI'
                ];
                
                testAddresses.forEach(addr => {
                    const isValid = moduleSystem.validateDeliveryAddress(addr);
                    log.textContent += `${isValid ? '‚úÖ' : '‚ùå'} validateDeliveryAddress("${addr}"): ${isValid}\n`;
                });
                
                log.textContent += '\n‚úÖ Test PDF completati con successo!\n';
                
            } catch (error) {
                log.textContent += `‚ùå Errore durante test: ${error.message}\n`;
            }
        }

        // Test sistema di fallback
        async function testFallbackSystem() {
            const log = document.getElementById('fallback-log');
            log.textContent = '';
            
            log.textContent += 'üîÑ Test sistema di fallback...\n\n';
            
            // Simula errore nel sistema modulare
            try {
                // Verifica se il fallback funziona
                if (window.DDTFTImport) {
                    log.textContent += '‚úÖ window.DDTFTImport disponibile\n';
                    log.textContent += `üì¶ Tipo: ${typeof window.DDTFTImport}\n`;
                    log.textContent += `üîß Funzioni: ${Object.keys(window.DDTFTImport).length}\n`;
                } else {
                    log.textContent += '‚ùå window.DDTFTImport NON disponibile\n';
                }
                
                // Test di compatibilit√†
                if (window.DDTExtractor) {
                    log.textContent += '‚úÖ window.DDTExtractor disponibile\n';
                } else {
                    log.textContent += '‚ùå window.DDTExtractor NON disponibile\n';
                }
                
                if (window.FatturaExtractor) {
                    log.textContent += '‚úÖ window.FatturaExtractor disponibile\n';
                } else {
                    log.textContent += '‚ùå window.FatturaExtractor NON disponibile\n';
                }
                
                log.textContent += '\n‚úÖ Test fallback completato!\n';
                
            } catch (error) {
                log.textContent += `‚ùå Errore durante test fallback: ${error.message}\n`;
            }
        }

        // Test performance
        async function testPerformance() {
            const log = document.getElementById('performance-log');
            log.textContent = '';
            
            log.textContent += '‚ö° Test performance...\n\n';
            
            if (!moduleSystem) {
                log.textContent += '‚ùå Sistema modulare non disponibile per test\n';
                return;
            }
            
            // Test velocit√† caricamento
            const iterations = 1000;
            
            // Test generateId
            console.time('generateId');
            for (let i = 0; i < iterations; i++) {
                moduleSystem.generateId();
            }
            console.timeEnd('generateId');
            
            // Test validateDeliveryAddress
            const testAddr = 'VIA ROMA 123 10100 TORINO TO';
            console.time('validateDeliveryAddress');
            for (let i = 0; i < iterations; i++) {
                moduleSystem.validateDeliveryAddress(testAddr);
            }
            console.timeEnd('validateDeliveryAddress');
            
            log.textContent += `‚úÖ Test performance completati!\n`;
            log.textContent += `üìä ${iterations} iterazioni per ogni funzione\n`;
            log.textContent += `üîç Controlla la console per i tempi dettagliati\n`;
        }

        // Aggiorna status
        function updateStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = type;
        }

        // Auto-start quando la pagina √® pronta
        document.addEventListener('DOMContentLoaded', () => {
            updateStatus('üü¢ Sistema pronto per i test!', 'success');
        });
    </script>
</body>
</html>