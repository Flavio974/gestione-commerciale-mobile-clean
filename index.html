<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#457b9d">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="SmartComm">
  <meta name="mobile-web-app-capable" content="yes">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">
  
  <!-- Apple Touch Icons -->
  <link rel="apple-touch-icon" sizes="152x152" href="icons/icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-180x180.png">
  <link rel="apple-touch-icon" sizes="167x167" href="icons/icon-167x167.png">
  
  <!-- Standard Icons -->
  <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="icons/icon-16x16.png">
  
  <!-- iOS specifici -->
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="format-detection" content="telephone=no">
  <meta name="msapplication-tap-highlight" content="no">
  
  <title>Smart Commercial Assistant - v2.1.4 SUPABASE FIX üáÆüáπ</title>
  
  <!-- üè∑Ô∏è BUILD STAMP per verificare deploy -->
  <script>console.info('üè∑Ô∏è BUILD-STAMP: 2025-07-14 00:25 - ENHANCED AI COMPLETO!');</script>
  
  <!-- ‚úÖ DEBUG COMPLETATO - Sistema stabile -->
  
  <!-- Cache Busting - Force reload date system -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  
  <!-- üßπ FIX CACHE: DISATTIVA COMPLETAMENTE SERVICE WORKER -->
  <script>
    // RIMUOVI TUTTI I SERVICE WORKER VECCHI
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations()
        .then(registrations => {
          registrations.forEach(registration => {
            console.log('üö´ Deregistrando SW:', registration.scope);
            registration.unregister();
          });
        });
    }
    
    // SVUOTA TUTTE LE CACHE
    if ('caches' in window) {
      caches.keys().then(names => {
        names.forEach(name => {
          console.log('üóëÔ∏è Eliminando cache:', name);
          caches.delete(name);
        });
      });
    }
    
    console.log('üßπ SW e cache eliminati - caricamento pulito');
  </script>

  <!-- üîí FIX FINALE 2025-07-13: BLOCCO TOTALE DEMO TAB MOVEMENT -->
  <script>
    // üîç RIMOSSO - Ora gestito dal monkey patch irrevocabile sopra
    // Il monkey patch Object.defineProperty √® pi√π potente e non pu√≤ essere sovrascritto
    console.log('üîç Monkey patch attivo - no ridefinizioni manuali necessarie');
    
    // Blocca timer che potrebbero essere cache-ati
    if (window.demoTabIntervalId) {
      clearInterval(window.demoTabIntervalId);
      window.demoTabIntervalId = null;
    }
    
    // üîí DEMO TAB PROTECTION RIMOSSA - Causava problemi di navigazione
    // Il createElement override interferiva con tutta la creazione DOM dell'app
    console.log('üîì Demo tab protection disattivata per ripristinare navigazione');
    
    // Funzione di emergenza disponibile immediatamente  
    window.emergencyOpenDemo = function() {
      console.log('üö® APERTURA EMERGENZA TAB DEMO...');
      
      // NON nascondere tutti i contenuti - solo attivare il demo tab
      // Rimuovi active solo dai tab (non dai contenuti)
      document.querySelectorAll('.tab-link').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Trova o crea il contenuto demo
      let demoContent = document.getElementById('demo-content');
      if (!demoContent) {
        console.log('‚ùå Demo content non trovato - creazione...');
        demoContent = document.createElement('div');
        demoContent.id = 'demo-content';
        demoContent.className = 'tab-content active';
        demoContent.style.cssText = 'display: block !important; position: fixed !important; top: 60px !important; left: 0 !important; right: 0 !important; bottom: 0 !important; background: white !important; z-index: 9999 !important; overflow-y: auto !important; padding: 20px !important;';
        demoContent.innerHTML = `
          <div style="max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
            <div style="text-align: right; margin-bottom: 20px;">
              <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background: #ff4757; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 14px;">‚úï Chiudi</button>
            </div>
            
            <h2 style="color: #00b894; margin-bottom: 20px; text-align: center;">üáÆüáπ Sistema Date Italiane</h2>
            <p style="font-size: 16px; color: #666; margin-bottom: 30px; text-align: center;">Sistema completo per la gestione delle date in formato italiano.</p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 30px 0;">
              
              <div style="padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #00b894;">
                <h4 style="color: #00b894; margin-bottom: 15px;">‚úÖ Validazione Date</h4>
                <div style="margin: 15px 0;">
                  <label style="display: block; margin-bottom: 5px; font-weight: bold;">Data da validare:</label>
                  <input type="text" id="dateInput" placeholder="es. 25/12/2025" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; margin-bottom: 10px;">
                  <button onclick="window.validateDemo && window.validateDemo()" style="width: 100%; padding: 12px; background: #00b894; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; font-weight: bold;">Valida Data</button>
                </div>
                <div id="dateValidationResult" style="margin-top: 15px; padding: 10px; border-radius: 4px; background: #fff;"></div>
              </div>
              
              <div style="padding: 20px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196f3;">
                <h4 style="color: #2196f3; margin-bottom: 15px;">üîÑ Conversione Date</h4>
                <div style="margin: 15px 0;">
                  <label style="display: block; margin-bottom: 5px; font-weight: bold;">Data italiana da convertire:</label>
                  <input type="text" id="conversionInput" placeholder="es. 25/12/2025" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; margin-bottom: 10px;">
                  <button onclick="window.convertDemo && window.convertDemo()" style="width: 100%; padding: 12px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; font-weight: bold;">Converti Data</button>
                </div>
                <div id="conversionResult" style="margin-top: 15px; padding: 10px; border-radius: 4px; background: #fff;"></div>
              </div>
              
            </div>
            
            <div style="margin-top: 30px; padding: 20px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
              <h4 style="color: #856404; margin-bottom: 15px;">üìö Funzioni Disponibili</h4>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                <button onclick="window.ItalianDateParser && window.ItalianDateParser.testParser && window.ItalianDateParser.testParser()" style="padding: 10px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Test Parser</button>
                <button onclick="alert('Data di oggi: ' + new Date().toLocaleDateString('it-IT'))" style="padding: 10px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer;">Data Oggi</button>
                <button onclick="alert('Formato ISO: ' + new Date().toISOString().split('T')[0])" style="padding: 10px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">Formato ISO</button>
                <button onclick="window.open('demo-italian-dates.html', '_blank')" style="padding: 10px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">Demo Completa</button>
              </div>
            </div>
            
            <div style="margin-top: 20px; padding: 15px; background: #d1ecf1; border-radius: 8px; text-align: center;">
              <p style="margin: 0; color: #0c5460; font-weight: bold;">‚úÖ Sistema Date Italiane Attivo - Versione 2.1.3</p>
            </div>
          </div>
        `;
        
        document.body.appendChild(demoContent);
      } else {
        // Mostra il contenuto esistente
        demoContent.classList.add('active');
        demoContent.style.display = 'block';
      }
      
      // Attiva il tab se esiste
      const demoTab = document.getElementById('tab-demo');
      if (demoTab) {
        demoTab.classList.add('active');
        demoTab.style.background = 'linear-gradient(135deg, #00b894, #00a085)';
        demoTab.style.color = 'white';
      }
      
      console.log('‚úÖ TAB DEMO APERTO IN MODALIT√Ä EMERGENZA!');
      return true;
    };
    
    // Funzioni demo semplificate
    window.validateDemo = function() {
      const input = document.getElementById('dateInput');
      const result = document.getElementById('dateValidationResult');
      if (!input || !result) return;
      
      const dateValue = input.value;
      const dateRegex = /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/;
      const match = dateValue.match(dateRegex);
      
      if (match) {
        const [, day, month, year] = match;
        const date = new Date(year, month - 1, day);
        const isValid = date.getDate() == day && date.getMonth() == month - 1 && date.getFullYear() == year;
        
        if (isValid) {
          result.innerHTML = '<div style="color: #155724; background: #d4edda; padding: 10px; border-radius: 4px; border: 1px solid #c3e6cb;">‚úÖ Data valida: ' + date.toLocaleDateString('it-IT', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'}) + '</div>';
        } else {
          result.innerHTML = '<div style="color: #721c24; background: #f8d7da; padding: 10px; border-radius: 4px; border: 1px solid #f5c6cb;">‚ùå Data non valida</div>';
        }
      } else {
        result.innerHTML = '<div style="color: #856404; background: #fff3cd; padding: 10px; border-radius: 4px; border: 1px solid #ffeaa7;">‚ö†Ô∏è Formato non valido. Usa DD/MM/YYYY</div>';
      }
    };
    
    window.convertDemo = function() {
      const input = document.getElementById('conversionInput');
      const result = document.getElementById('conversionResult');
      if (!input || !result) return;
      
      const dateValue = input.value;
      const dateRegex = /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/;
      const match = dateValue.match(dateRegex);
      
      if (match) {
        const [, day, month, year] = match;
        const date = new Date(year, month - 1, day);
        const isValid = date.getDate() == day && date.getMonth() == month - 1 && date.getFullYear() == year;
        
        if (isValid) {
          const isoDate = date.toISOString().split('T')[0];
          const usFormat = date.toLocaleDateString('en-US');
          const timestamp = date.getTime();
          
          result.innerHTML = `
            <div style="color: #004085; background: #cce7ff; padding: 15px; border-radius: 4px; border: 1px solid #99d3ff;">
              <strong>üîÑ Conversioni per: ${dateValue}</strong><br><br>
              <strong>ISO 8601:</strong> ${isoDate}<br>
              <strong>Formato US:</strong> ${usFormat}<br>
              <strong>Timestamp:</strong> ${timestamp}<br>
              <strong>UTC:</strong> ${date.toUTCString()}
            </div>
          `;
        } else {
          result.innerHTML = '<div style="color: #721c24; background: #f8d7da; padding: 10px; border-radius: 4px; border: 1px solid #f5c6cb;">‚ùå Data non valida per conversione</div>';
        }
      } else {
        result.innerHTML = '<div style="color: #856404; background: #fff3cd; padding: 10px; border-radius: 4px; border: 1px solid #ffeaa7;">‚ö†Ô∏è Formato non valido. Usa DD/MM/YYYY</div>';
      }
    };
    
    console.log('üö® SISTEMA EMERGENZA DEMO TAB CARICATO!');
    console.log('üí° Usa: emergencyOpenDemo() per aprire il tab demo');
    
    // üö® MONITORAGGIO CONTINUO DEL TAB DEMO
    let demoTabMonitor = null;
    
    // Funzione per assicurare sempre la visibilit√† del tab demo
    function ensureDemoTabAlwaysVisible() {
      const demoTab = document.getElementById('tab-demo');
      if (demoTab) {
        // Forza sempre visibile e cliccabile
        demoTab.style.display = 'block !important';
        demoTab.style.visibility = 'visible !important';
        demoTab.style.opacity = '1 !important';
        demoTab.style.pointerEvents = 'auto !important';
        demoTab.style.position = 'relative !important';
        demoTab.style.zIndex = '1000 !important';
        
        // Assicura che abbia sempre un gestore click funzionante
        if (!demoTab._hasEmergencyClick) {
          demoTab.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('üî• DEMO TAB CLICK - NAVIGAZIONE NORMALE');
            
            // Navigazione normale invece di emergency
            if (window.App && window.App.showTab) {
              window.App.showTab('demo-content');
            } else {
              // Fallback: navigazione manuale normale
              document.querySelectorAll('.tab-link').forEach(tab => tab.classList.remove('active'));
              document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
              
              this.classList.add('active');
              const demoContent = document.getElementById('demo-content');
              if (demoContent) demoContent.classList.add('active');
            }
          });
          demoTab._hasEmergencyClick = true;
        }
      }
    }
    
    // ‚ùå RIMOSSO: Monitoraggio problematico che causava rallentamenti
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üì± App caricata - demo tab lasciato al comportamento naturale');
    });
    
    console.log('üì± Demo tab sistema rimosso - niente pi√π interferenze');
    
    // üßπ FUNZIONE PER CANCELLARE LA CRONOLOGIA CHAT AI
    window.clearAIChatHistory = function() {
      console.log('üßπ Cancellazione cronologia chat AI...');
      
      try {
        // 1. Trova e pulisci tutti i possibili contenitori chat
        const chatContainers = [
          document.getElementById('aiChatMessages'),
          document.querySelector('.ai-chat-messages'),
          document.querySelector('#ai-chat-messages'),
          document.querySelector('[class*="chat-messages"]'),
          document.querySelector('#ai-content .chat-container'),
          document.querySelector('#ai-content .messages-container')
        ];
        
        let chatCleared = false;
        chatContainers.forEach(container => {
          if (container) {
            container.innerHTML = '';
            chatCleared = true;
            console.log('‚úÖ Container chat pulito:', container.id || container.className);
          }
        });
        
        // 2. Pulisci anche il div ai-messages dell'interfaccia corrente
        const aiMessagesDiv = document.getElementById('ai-messages');
        if (aiMessagesDiv) {
          aiMessagesDiv.innerHTML = '';
          chatCleared = true;
          console.log('‚úÖ Div ai-messages pulito');
        }
        
        // 3. Rimuovi tutti i possibili storage della cronologia
        const storageKeys = [
          'ai_conversation_history',
          'gc_mobile_ai_history',
          'ai_chat_history',
          'flavioAI_history',
          'smart_assistant_history',
          'gc_mobile_ai_messages',
          'ai_messages'
        ];
        
        storageKeys.forEach(key => {
          if (localStorage.getItem(key)) {
            localStorage.removeItem(key);
            console.log('‚úÖ Rimosso storage:', key);
          }
        });
        
        // 3. Pulisci anche sessionStorage
        storageKeys.forEach(key => {
          if (sessionStorage.getItem(key)) {
            sessionStorage.removeItem(key);
            console.log('‚úÖ Rimosso session storage:', key);
          }
        });
        
        // 4. Se c'√® un'istanza di FlavioAI, resetta anche quella
        if (window.flavioAI && window.flavioAI.conversationHistory) {
          window.flavioAI.conversationHistory = [];
          console.log('‚úÖ Reset conversationHistory in flavioAI');
        }
        
        // 5. Se c'√® SmartAssistant, resetta anche quello
        if (window.SmartAssistant && window.SmartAssistant.chatHistory) {
          window.SmartAssistant.chatHistory = [];
          console.log('‚úÖ Reset chatHistory in SmartAssistant');
        }
        
        // 6. Notifica successo
        if (chatCleared || storageKeys.some(key => localStorage.getItem(key))) {
          // Mostra notifica di successo
          const notification = document.createElement('div');
          notification.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #28a745;
            color: white;
            padding: 20px 40px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 9999;
            animation: fadeInOut 2s ease-in-out;
          `;
          notification.textContent = '‚úÖ Cronologia cancellata con successo!';
          document.body.appendChild(notification);
          
          setTimeout(() => notification.remove(), 2000);
          
          console.log('‚úÖ Cronologia AI cancellata con successo!');
        } else {
          alert('‚ÑπÔ∏è Nessuna cronologia da cancellare');
        }
        
        // 7. Ricarica eventuali componenti UI
        if (window.flavioAI && window.flavioAI.renderChatInterface) {
          window.flavioAI.renderChatInterface();
        }
        
      } catch (error) {
        console.error('‚ùå Errore durante la cancellazione:', error);
        alert('‚ùå Errore durante la cancellazione della cronologia');
      }
    };
    
    // ‚úÖ FUNZIONE SEMPLICE PER PULSANTE CANCELLA CHAT
    window.clearAIChat = function() {
      console.log('üóëÔ∏è Pulsante cancella chat premuto');
      
      // Chiama la funzione principale
      window.clearAIChatHistory();
      
      // Pulisci anche la cronologia di FlavioAIAssistant se presente
      if (window.FlavioAIAssistant && window.FlavioAIAssistant.chatHistory) {
        window.FlavioAIAssistant.chatHistory = [];
        console.log('‚úÖ Cronologia FlavioAIAssistant pulita');
      }
      
      // Reset anche il session storage dei token se si vuole
      // sessionStorage.removeItem('total_tokens_used');
      // sessionStorage.removeItem('last_request_tokens');
    };
    
    // üí∞ CALCOLO COSTI APPROSSIMATIVI AI
    window.calculateAICost = function(tokens, modelName, provider) {
      if (!tokens || tokens <= 0) return 0;
      
      // Prezzi approssimativi per 1000 token (aggiornati a luglio 2025)
      const pricing = {
        'openai': {
          'gpt-4': 0.03,           // $0.03 per 1K token
          'gpt-4-turbo': 0.01,     // $0.01 per 1K token
          'gpt-4o': 0.005,         // $0.005 per 1K token
          'gpt-4o-mini': 0.0015,   // $0.0015 per 1K token
          'gpt-3.5-turbo': 0.002,  // $0.002 per 1K token
          'o1-preview': 0.015,     // $0.015 per 1K token
          'o1-mini': 0.003,        // $0.003 per 1K token
          'o1-pro': 0.06          // $0.06 per 1K token
        },
        'anthropic': {
          'claude-opus-4-20250514': 0.015,        // $0.015 per 1K token
          'claude-sonnet-4-20250514': 0.003,      // $0.003 per 1K token
          'claude-3-5-sonnet-20241022': 0.003,    // $0.003 per 1K token
          'claude-3-5-haiku-20241022': 0.00025,   // $0.00025 per 1K token
          'claude-3-opus-20240229': 0.015,        // $0.015 per 1K token
          'claude-3-sonnet-20240229': 0.003,      // $0.003 per 1K token
          'claude-3-haiku-20240307': 0.00025,     // $0.00025 per 1K token
          'claude-2.1': 0.008,                    // $0.008 per 1K token
          'claude-instant-1.2': 0.0008           // $0.0008 per 1K token
        }
      };
      
      // Trova il prezzo per il modello
      let pricePerK = 0;
      if (pricing[provider] && pricing[provider][modelName]) {
        pricePerK = pricing[provider][modelName];
      } else {
        // Fallback: prezzi medi per provider
        pricePerK = provider === 'openai' ? 0.01 : 0.005;
      }
      
      // Calcola costo in USD
      const costUSD = (tokens / 1000) * pricePerK;
      
      // Converti in EUR (cambio approssimativo)
      const eurRate = 0.85; // 1 USD = 0.85 EUR circa
      const costEUR = costUSD * eurRate;
      
      return {
        usd: costUSD,
        eur: costEUR,
        tokens: tokens,
        model: modelName,
        provider: provider
      };
    };
    
    // üìÖ GESTIONE DATI GIORNALIERI
    window.getTodayKey = function() {
      const today = new Date();
      return `ai_daily_${today.getFullYear()}_${today.getMonth() + 1}_${today.getDate()}`;
    };
    
    window.updateDailyStats = function(tokens, modelName, provider) {
      if (!tokens || tokens <= 0) return;
      
      const todayKey = window.getTodayKey();
      let dailyData = JSON.parse(localStorage.getItem(todayKey) || '{}');
      
      // Inizializza se non esiste
      if (!dailyData.totalTokens) {
        dailyData = {
          totalTokens: 0,
          totalCostUSD: 0,
          totalCostEUR: 0,
          interactions: 0,
          models: {},
          date: new Date().toISOString().split('T')[0]
        };
      }
      
      // Aggiorna dati
      dailyData.totalTokens += tokens;
      dailyData.interactions += 1;
      
      // Calcola costo
      const cost = window.calculateAICost(tokens, modelName, provider);
      dailyData.totalCostUSD += cost.usd || 0;
      dailyData.totalCostEUR += cost.eur || 0;
      
      // Traccia modelli usati
      const modelKey = `${provider}_${modelName}`;
      if (!dailyData.models[modelKey]) {
        dailyData.models[modelKey] = { tokens: 0, interactions: 0 };
      }
      dailyData.models[modelKey].tokens += tokens;
      dailyData.models[modelKey].interactions += 1;
      
      // Salva
      localStorage.setItem(todayKey, JSON.stringify(dailyData));
      console.log('üìÖ Dati giornalieri aggiornati:', dailyData);
    };
    
    window.getDailyStats = function() {
      const todayKey = window.getTodayKey();
      return JSON.parse(localStorage.getItem(todayKey) || '{"totalTokens": 0, "totalCostUSD": 0, "totalCostEUR": 0, "interactions": 0}');
    };
    
    // Aggiungi animazione per la notifica (scope isolato)
    (function() {
      if (!document.getElementById('chat-clear-animation')) {
        const styleElement = document.createElement('style');
        styleElement.id = 'chat-clear-animation';
        styleElement.textContent = `
          @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
          }
        `;
        document.head.appendChild(styleElement);
      }
    })();
  </script>
  
  <!-- CSS Files -->
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/mobile.css">
  
  <!-- Component Styles -->
  <link rel="stylesheet" href="css/base-components.css">
  <link rel="stylesheet" href="css/timeline-components.css">
  <link rel="stylesheet" href="css/modal-components.css">
  <link rel="stylesheet" href="css/ui-components.css">
  
  <!-- Module Styles -->
  <link rel="stylesheet" href="css/clients-module.css">
  <link rel="stylesheet" href="css/orders-module.css">
  <link rel="stylesheet" href="css/ordini.css">
  <link rel="stylesheet" href="css/vocabulary-dialog.css">
  <link rel="stylesheet" href="css/ddtft-module.css">
  <link rel="stylesheet" href="css/products-module.css">
  <link rel="stylesheet" href="css/percorsi-module.css">
  <link rel="stylesheet" href="css/worksheet-module.css">
  <link rel="stylesheet" href="css/worksheet.css">
  <link rel="stylesheet" href="css/smart-assistant.css">
  <link rel="stylesheet" href="css/ai-assistant-mobile-fix.css">
  <link rel="stylesheet" href="css/comandi-module.css">
  
  <!-- Voice Controls V2 per iPad -->
  <link rel="stylesheet" href="css/voice-controls-v2.css">
  
  <!-- TEST CSS iPhone INLINE -->
  <style>
    @media screen and (max-width: 390px) {
      #ai-content input {
        height: 60px !important;
        font-size: 18px !important;
        padding: 15px !important;
      }
      
      /* Evidenzia la spiegazione modalit√† vocale su mobile */
      .ai-config-item small {
        font-size: 14px !important;
        color: #007bff !important;
        font-weight: 500 !important;
        background: #f0f8ff;
        padding: 8px;
        border-radius: 4px;
        border-left: 3px solid #007bff;
      }
      
      /* MOBILE VOICE CONTROLS - Mostra solo su piccoli schermi */
      .mobile-voice-controls {
        display: block !important;
      }
      
      /* DESKTOP CONTROLS - Nascondi su piccoli schermi */
      .button-row-mobile {
        display: none !important;
      }
      
      /* INPUT OTTIMIZZATO MOBILE */
      .ai-input-mobile {
        -webkit-appearance: none !important;
        font-size: 18px !important; /* Previene zoom iOS */
      }
      
      /* OTTIMIZZAZIONI VOICE CONTROLS V2 per iPhone */
      #voice-controls-v2 {
        right: 5px !important;
        top: 5px !important;
      }
      
      /* Garantisce spazio per i controlli vocali */
      .container-fluid {
        padding-right: 70px !important;
      }
      
      /* Header ottimizzato per iPhone */
      .navbar {
        padding-right: 70px !important;
      }
    }
  </style>
  
  <!-- Mobile Responsive -->
  <link rel="stylesheet" href="css/mobile-responsive.css">
  
  <link rel="stylesheet" href="css/tables.css">
  
  <!-- External Libraries -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  
  <!-- Fix inline per visibilit√† pulsanti -->
  <style>
    /* Fix globale per tutti i pulsanti */
    button {
      opacity: 1 !important;
      visibility: visible !important;
    }
    
    /* Fix specifico per modulo DDT/FT */
    #ddtft-content button,
    #ddtft-content .action-button,
    #ddtft-content .btn,
    #ddtft-content .filter-btn {
      opacity: 1 !important;
      visibility: visible !important;
      display: inline-flex !important;
      align-items: center !important;
      gap: 0.5rem !important;
      padding: 10px 20px !important;
      border-radius: 5px !important;
      cursor: pointer !important;
      font-weight: 500 !important;
      transition: all 0.3s ease !important;
    }
    
    #ddtft-content .action-button:not(.action-button-danger) {
      background-color: #007bff !important;
      color: white !important;
      border: none !important;
    }
    
    #ddtft-content .action-button-danger {
      background-color: #dc3545 !important;
      color: white !important;
      border: none !important;
    }
    
    #ddtft-content .filter-btn {
      background-color: white !important;
      color: #495057 !important;
      border: 1px solid #dee2e6 !important;
    }
    
    #ddtft-content .filter-btn.active {
      background-color: #007bff !important;
      color: white !important;
      border-color: #007bff !important;
    }
    
    #ddtft-content .btn-primary {
      background-color: #007bff !important;
      color: white !important;
      border: none !important;
    }
    
    #ddtft-content .btn-secondary {
      background-color: #6c757d !important;
      color: white !important;
      border: none !important;
    }
    
    #ddtft-content .btn-icon {
      padding: 8px 12px !important;
      background-color: #f8f9fa !important;
      color: #495057 !important;
      border: 1px solid #dee2e6 !important;
    }
    
    #ddtft-content .btn-delete {
      background-color: #dc3545 !important;
      color: white !important;
      border: none !important;
    }
    
    /* Modal overlay for DDT-FT export dialog */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .modal-overlay .modal-content {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-overlay .modal-header {
      padding: 20px;
      border-bottom: 1px solid #e9ecef;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-overlay .modal-header h3 {
      margin: 0;
      color: #333;
    }
    
    .modal-overlay .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #999;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal-overlay .close-btn:hover {
      color: #333;
    }
    
    .modal-overlay .modal-body {
      padding: 20px;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }
    
    .btn-primary {
      background-color: #007bff;
      color: white;
    }
    
    .btn-primary:hover {
      background-color: #0056b3;
    }
    
    .btn-secondary {
      background-color: #6c757d;
      color: white;
    }
    
    .btn-secondary:hover {
      background-color: #5a6268;
    }
    
    .btn-warning {
      background-color: #ffc107;
      color: #212529;
    }
    
    .btn-warning:hover {
      background-color: #e0a800;
    }
    
    .btn-danger {
      background-color: #dc3545;
      color: white;
    }
    
    .btn-danger:hover {
      background-color: #c82333;
    }
    
    /* STILI AI ASSISTANT */
    #ai-content {
      padding: 20px;
      max-width: 100%;
      margin: 0 auto;
    }
    
    .ai-header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .ai-header h2 {
      color: #457b9d;
      margin-bottom: 10px;
    }
    
    .ai-config {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    .ai-config-item {
      margin-bottom: 15px;
    }
    
    .ai-config label {
      display: block;
      font-weight: 600;
      margin-bottom: 5px;
      color: #495057;
    }
    
    .ai-config input,
    .ai-config select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      font-size: 14px;
    }
    
    .ai-chat-container {
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      overflow: hidden;
      height: 500px;
      display: flex;
      flex-direction: column;
    }
    
    .ai-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: #f8f9fa;
    }
    
    .ai-message {
      margin-bottom: 15px;
      display: flex;
      gap: 10px;
    }
    
    .ai-message.user {
      justify-content: flex-end;
    }
    
    .ai-message-content {
      max-width: 70%;
      padding: 10px 15px;
      border-radius: 12px;
      word-wrap: break-word;
    }
    
    .ai-message.user .ai-message-content {
      background: #457b9d;
      color: white;
    }
    
    .ai-message.assistant .ai-message-content {
      background: white;
      border: 1px solid #e9ecef;
    }
    
    .ai-message-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
    }
    
    .ai-message.user .ai-message-avatar {
      background: #6c757d;
      color: white;
      order: 1;
    }
    
    .ai-message.assistant .ai-message-avatar {
      background: #28a745;
      color: white;
    }
    
    .ai-input-container {
      padding: 20px;
      background: white;
      border-top: 1px solid #dee2e6;
      display: flex;
      gap: 10px;
    }
    
    .ai-input {
      flex: 1;
      padding: 10px 15px;
      border: 1px solid #ced4da;
      border-radius: 20px;
      font-size: 14px;
      outline: none;
    }
    
    .ai-input:focus {
      border-color: #457b9d;
    }
    
    .ai-send-btn {
      padding: 10px 20px;
      background: #457b9d;
      color: white;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s;
    }
    
    .ai-send-btn:hover {
      background: #326891;
    }
    
    .ai-send-btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }
    
    .ai-voice-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      background: #dc3545;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }
    
    .ai-voice-btn:hover {
      background: #c82333;
    }
    
    .ai-voice-btn.recording {
      background: #28a745;
      animation: pulse 1.5s infinite;
    }

    /* üé§ PULSANTI FLOTTANTI VOCALI TRASCINABILI - MODALIT√Ä AUTOMOBILE */
    .floating-voice-container {
      position: fixed;
      bottom: 30px;
      right: 30px;
      display: flex;
      flex-direction: column;
      gap: 15px;
      z-index: 1000;
      cursor: move;
      user-select: none;
      touch-action: none;
      transition: all 0.3s ease;
      padding: 10px;
      border-radius: 15px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 255, 255, 0.2);
    }

    .floating-voice-container.dragging {
      opacity: 0.9;
      transform: scale(1.05);
      transition: none !important;
      box-shadow: 0 8px 35px rgba(0, 122, 255, 0.4);
      border-color: rgba(0, 122, 255, 0.6) !important;
      cursor: grabbing !important;
    }

    .floating-voice-container::before {
      content: "‚ãÆ‚ãÆ";
      position: absolute;
      top: -5px;
      left: 50%;
      transform: translateX(-50%);
      color: rgba(0, 122, 255, 0.5);
      font-size: 16px;
      opacity: 0.7;
    }

    .floating-voice-container::after {
      content: "Trascinami per spostare";
      position: absolute;
      top: -35px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      opacity: 0;
      transition: opacity 0.3s ease;
      white-space: nowrap;
      pointer-events: none;
    }

    .floating-voice-container:hover::after {
      opacity: 1;
    }

    .floating-mic-btn {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      border: none;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      pointer-events: auto;
    }

    .floating-mic-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 12px 40px rgba(0,0,0,0.4);
    }

    .floating-mic-btn.listening {
      animation: pulse 1.5s infinite;
      background: linear-gradient(135deg, #00d2ff, #3a7bd5);
    }

    .floating-mic-btn.auto-mode {
      background: linear-gradient(135deg, #00b894, #00a085);
    }

    .stop-btn-pulse {
      animation: stopPulse 1s infinite !important;
    }

    @keyframes stopPulse {
      0% {
        box-shadow: 0 8px 32px rgba(255, 69, 58, 0.4), 0 0 0 0 rgba(255, 69, 58, 0.7);
      }
      70% {
        box-shadow: 0 8px 32px rgba(255, 69, 58, 0.4), 0 0 0 10px rgba(255, 69, 58, 0);
      }
      100% {
        box-shadow: 0 8px 32px rgba(255, 69, 58, 0.4), 0 0 0 0 rgba(255, 69, 58, 0);
      }
    }

    .floating-voice-status {
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      text-align: center;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
      pointer-events: none;
    }

    /* üéõÔ∏è CONTROLLI AVANZATI VOCALI */
    .main-voice-controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: center;
    }

    .voice-advanced-controls {
      background: rgba(255, 255, 255, 0.98);
      border-radius: 15px;
      padding: 15px;
      margin-top: 15px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(10px);
      border: 2px solid rgba(0, 122, 255, 0.3);
      width: 280px;
      max-width: 90vw;
      font-size: 13px;
      color: #333;
    }

    .advanced-controls-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(0, 122, 255, 0.2);
    }

    .advanced-controls-header h4 {
      margin: 0;
      color: #007bff;
      font-size: 14px;
    }

    .control-group {
      margin-bottom: 15px;
    }

    .control-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #495057;
      font-size: 12px;
    }

    .control-group input[type="range"] {
      width: 100%;
      margin: 5px 0;
      accent-color: #007bff;
    }

    .control-group select {
      width: 100%;
      padding: 6px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      font-size: 12px;
      background: white;
    }

    .mode-btn {
      padding: 6px 12px;
      border: 1px solid #007bff;
      background: white;
      color: #007bff;
      border-radius: 4px;
      cursor: pointer;
      font-size: 11px;
      transition: all 0.2s;
    }

    .mode-btn.active {
      background: #007bff;
      color: white;
    }

    .mode-btn:hover {
      background: #0056b3;
      color: white;
    }

    #volume-display, #speed-display {
      font-weight: bold;
      color: #007bff;
      margin-left: 10px;
    }
    
    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
      }
      70% {
        box-shadow: 0 0 0 10px rgba(40, 167, 69, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);
      }
    }
    
    .ai-status {
      padding: 10px;
      background: #f8f9fa;
      border-radius: 4px;
      margin-bottom: 10px;
      font-size: 14px;
      color: #6c757d;
      text-align: center;
    }
    
    .ai-status.error {
      background: #f8d7da;
      color: #721c24;
    }
    
    .ai-status.success {
      background: #d4edda;
      color: #155724;
    }
    
    .ai-capabilities {
      background: #e9ecef;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
    }
    
    .ai-capabilities h4 {
      margin-bottom: 10px;
      color: #495057;
    }
    
    .ai-capabilities ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .ai-capabilities li {
      padding: 5px 0;
      padding-left: 20px;
      position: relative;
    }
    
    .ai-capabilities li:before {
      content: "‚úì";
      position: absolute;
      left: 0;
      color: #28a745;
      font-weight: bold;
    }
    
    .ai-thinking {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      color: #6c757d;
      font-style: italic;
    }
    
    .ai-thinking-dots {
      display: flex;
      gap: 4px;
    }
    
    .ai-thinking-dots span {
      width: 8px;
      height: 8px;
      background: #6c757d;
      border-radius: 50%;
      animation: thinking 1.4s infinite;
    }
    
    .ai-thinking-dots span:nth-child(2) {
      animation-delay: 0.2s;
    }
    
    .ai-thinking-dots span:nth-child(3) {
      animation-delay: 0.4s;
    }
    
    @keyframes thinking {
      0%, 60%, 100% {
        transform: translateY(0);
      }
      30% {
        transform: translateY(-10px);
      }
    }
    
    /* Pulsanti rapidi */
    .ai-quick-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 15px 0;
    }
    
    .ai-quick-actions .btn-sm {
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 15px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .ai-quick-actions .btn-sm:hover {
      background-color: #457b9d;
      color: white;
      transform: translateY(-1px);
    }
    
    /* Status indicators */
    .ai-status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .ai-status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .ai-status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    
    .ai-status.warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    
    .rate-limit-notice {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .rate-limit-notice .btn {
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      border: none;
    }
    
    .rate-limit-notice .btn-primary {
      background-color: #007bff;
      color: white;
    }
    
    .rate-limit-notice .btn-secondary {
      background-color: #6c757d;
      color: white;
    }
    
    .cost-warning {
      background: #fff5f5;
      border: 2px solid #e53e3e;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
    }
    
    .cost-warning .btn {
      font-size: 12px;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      border: none;
      margin: 2px;
    }
    
    .cost-warning .btn-danger {
      background-color: #e53e3e;
      color: white;
    }
    
    .cost-warning .btn-secondary {
      background-color: #6c757d;
      color: white;
    }
    
    /* Responsive per mobile */
    @media (max-width: 768px) {
      #ai-content {
        padding: 10px;
      }
      
      .ai-chat-container {
        height: calc(100vh - 300px);
      }
      
      .ai-message-content {
        max-width: 85%;
      }
      
      .ai-config {
        padding: 15px;
      }
      
      .ai-quick-actions {
        justify-content: center;
      }
      
      .ai-quick-actions .btn-sm {
        flex: 1;
        min-width: 0;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <!-- üßπ KILL SW DRASTICO - BLOCCA TUTTO -->
  <script>
    // BLOCCA REGISTRAZIONE SW PREVENTIVAMENTE
    if ('serviceWorker' in navigator) {
      delete navigator.serviceWorker;
      console.log('üö´ ServiceWorker API DISABILITATO');
    }
    
    // Kill SW & cache il prima possibile - SYNC per bloccare tutto
    (async () => {
      if ('serviceWorker' in navigator) {
        console.log('üßπ Killing Service Workers...');
        const regs = await navigator.serviceWorker.getRegistrations();
        await Promise.all(regs.map(r => {
          console.log('üö´ Unregistering SW:', r.scope);
          return r.unregister();
        }));
        console.log('‚úÖ SW rimossi all\'avvio');
      }
      if (window.caches) {
        console.log('üóëÔ∏è Clearing all caches...');
        const names = await caches.keys();
        await Promise.all(names.map(n => {
          console.log('üóëÔ∏è Deleting cache:', n);
          return caches.delete(n);
        }));
        console.log('‚úÖ Cache svuotate');
      }
      console.log('üßπ CLEAN START - No SW, No Cache');
    })();
    
    // üêõ DEBUG: Cattura errori Uncaught per identificarli
    window.addEventListener('error', (e) => {
      console.error('üö® UNCAUGHT ERROR DETECTED:');
      console.error('File:', e.filename);
      console.error('Line:', e.lineno, 'Col:', e.colno);
      console.error('Error:', e.error);
      console.error('Message:', e.message);
      console.error('Stack:', e.error?.stack);
      // Non preventDefault - lascia che l'errore si propaghi per debug
    });
    
    console.log('üêõ Error listener attivo - catturer√† tutti gli Uncaught');
  </script>
  
  <!-- Funzioni Debug iPad -->
  <script>
    // Mostra/nascondi pannello debug
    function toggleDebugPanel() {
      const panel = document.getElementById('ipad-debug-panel');
      panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    }
    
    // Attiva modalit√† iPad forzata
    function forceIPadMode() {
      localStorage.setItem('force_ipad_mode', 'true');
      alert('Modalit√† iPad forzata attivata. Ricarica la pagina.');
      location.reload();
    }
    
    // Test TTS diretto
    function testTTS() {
      if (window.iosTTSManager) {
        window.iosTTSManager.speak('Test TTS diretto da pannello debug');
      } else {
        alert('iosTTSManager non disponibile');
      }
    }

    // Test delle voci specifiche
    function testVoiceCosimo() {
      if (window.iosTTSManager) {
        const voices = speechSynthesis.getVoices();
        const cosimoVoice = voices.find(v => v.name.toLowerCase().includes('cosimo'));
        if (cosimoVoice) {
          window.iosTTSManager.selectedVoice = cosimoVoice;
          window.iosTTSManager.speak('Ciao, sono Cosimo. Mi senti bene?');
        } else {
          // Prova con prima voce italiana Microsoft
          const microsoftVoice = voices.find(v => v.name.toLowerCase().includes('microsoft') && v.lang.includes('it'));
          if (microsoftVoice) {
            window.iosTTSManager.selectedVoice = microsoftVoice;
            window.iosTTSManager.speak('Ciao, sono una voce Microsoft italiana. Mi senti bene?');
          } else {
            alert('Nessuna voce Microsoft italiana trovata');
          }
        }
      }
    }

    function testVoiceElsa() {
      if (window.iosTTSManager) {
        const voices = speechSynthesis.getVoices();
        const elsaVoice = voices.find(v => v.name.toLowerCase().includes('elsa'));
        if (elsaVoice) {
          window.iosTTSManager.selectedVoice = elsaVoice;
          window.iosTTSManager.speak('Ciao, sono Elsa. Mi senti bene?');
        } else {
          // Prova con seconda voce italiana
          const italianVoices = voices.filter(v => v.lang.includes('it'));
          if (italianVoices.length > 1) {
            window.iosTTSManager.selectedVoice = italianVoices[1];
            window.iosTTSManager.speak('Ciao, sono la seconda voce italiana. Mi senti bene?');
          } else {
            alert('Seconda voce italiana non trovata');
          }
        }
      }
    }

    function testVoiceGoogle() {
      if (window.iosTTSManager) {
        const voices = speechSynthesis.getVoices();
        const googleVoice = voices.find(v => v.name.toLowerCase().includes('google') && v.lang.includes('it'));
        if (googleVoice) {
          window.iosTTSManager.selectedVoice = googleVoice;
          window.iosTTSManager.speak('Ciao, sono Google italiano. Mi senti bene?');
        } else {
          // Prova con qualsiasi voce Google
          const anyGoogleVoice = voices.find(v => v.name.toLowerCase().includes('google'));
          if (anyGoogleVoice) {
            window.iosTTSManager.selectedVoice = anyGoogleVoice;
            window.iosTTSManager.speak('Hello, I am Google voice. Can you hear me?');
          } else {
            alert('Nessuna voce Google trovata');
          }
        }
      }
    }

    function testVolumeMax() {
      if (window.iosTTSManager) {
        const utterance = new SpeechSynthesisUtterance('Test volume massimo! Dovresti sentirmi molto forte!');
        utterance.volume = 1.0;
        utterance.rate = 1.0;
        utterance.pitch = 1.0;
        utterance.lang = 'it-IT';
        speechSynthesis.cancel();
        speechSynthesis.speak(utterance);
      }
    }

    function testSlowSpeech() {
      if (window.iosTTSManager) {
        const utterance = new SpeechSynthesisUtterance('Test velocit√† lenta. Ogni parola dovrebbe essere chiara e distinta.');
        utterance.volume = 1.0;
        utterance.rate = 0.6;
        utterance.pitch = 1.0;
        utterance.lang = 'it-IT';
        speechSynthesis.cancel();
        speechSynthesis.speak(utterance);
      }
    }

    function testVoiceDaria() {
      if (window.iosTTSManager) {
        const voices = speechSynthesis.getVoices();
        const dariaVoice = voices.find(v => v.name.toLowerCase().includes('daria'));
        if (dariaVoice) {
          window.iosTTSManager.selectedVoice = dariaVoice;
          window.iosTTSManager.speak('Ciao, sono Daria. Mi senti bene?');
        } else {
          // Usa la prima voce disponibile
          if (voices.length > 0) {
            window.iosTTSManager.selectedVoice = voices[0];
            window.iosTTSManager.speak('Ciao, sono la prima voce disponibile. Mi senti bene?');
          } else {
            alert('Nessuna voce disponibile');
          }
        }
      }
    }

    function showAllVoices() {
      const voices = speechSynthesis.getVoices();
      let voiceList = 'Voci disponibili:\n\n';
      
      voices.forEach((voice, index) => {
        voiceList += `${index}: ${voice.name} (${voice.lang})\n`;
      });
      
      alert(voiceList);
    }

    function checkMiddlewareStatus() {
      const status = {
        middlewareIntegration: !!window.middlewareIntegration,
        supabaseAI: !!window.supabaseAI,
        vocabularyManager: !!window.vocabularyManager,
        requestMiddleware: !!window.requestMiddleware,
        aiMiddleware: !!window.aiMiddleware,
        supabaseClient: !!window.supabase,
        robustConnectionManager: !!window.robustConnectionManager
      };
      
      let statusText = 'üîå STATO MIDDLEWARE:\n\n';
      Object.entries(status).forEach(([key, value]) => {
        statusText += `${value ? '‚úÖ' : '‚ùå'} ${key}: ${value ? 'OK' : 'NON TROVATO'}\n`;
      });
      
      // Controlla se middleware √® attivo
      if (window.middlewareIntegration && window.middlewareIntegration.isActive) {
        statusText += '\nüîå Middleware: ATTIVO';
      } else {
        statusText += '\n‚ö†Ô∏è Middleware: NON ATTIVO';
      }
      
      // Controlla sistema robusto
      if (window.robustConnectionManager) {
        const robustStatus = window.robustConnectionManager.getStatus();
        statusText += '\n\nüîå SISTEMA ROBUSTO:';
        statusText += `\n‚úÖ Attivo: ${robustStatus.isActive ? 'S√å' : 'NO'}`;
        statusText += `\n‚úÖ Connesso: ${robustStatus.isFullyConnected ? 'S√å' : 'NO'}`;
        statusText += `\nüîÑ Tentativi: ${robustStatus.reconnectAttempts}`;
        
        statusText += '\n\nüìä CONNESSIONI:';
        Object.entries(robustStatus.connections).forEach(([key, value]) => {
          statusText += `\n${value ? '‚úÖ' : '‚ùå'} ${key}`;
        });
      }
      
      alert(statusText);
    }

    function restartMiddleware() {
      console.log('üîå Riavvio middleware...');
      
      try {
        // Usa il sistema robusto se disponibile
        if (window.robustConnectionManager) {
          console.log('üîå Uso sistema connessione robusta...');
          
          window.robustConnectionManager.start().then((connected) => {
            if (connected) {
              alert('‚úÖ Sistema connessione robusta attivato! Prova ora i comandi vocali.');
            } else {
              alert('‚ö†Ô∏è Sistema connessione robusta avviato ma non completamente connesso. Riprova tra qualche secondo.');
            }
          }).catch((error) => {
            console.error('‚ùå Errore sistema robusto:', error);
            alert('‚ùå Errore sistema robusto: ' + error.message);
          });
          
          return;
        }
        
        // Fallback al sistema classico
        console.log('üîå Fallback al sistema classico...');
        
        // Verifica che tutti i componenti siano presenti
        if (!window.SupabaseAIIntegration) {
          alert('‚ùå SupabaseAIIntegration non disponibile');
          return;
        }
        
        if (!window.VocabularyManager) {
          alert('‚ùå VocabularyManager non disponibile');
          return;
        }
        
        // Inizializza manualmente i componenti
        if (!window.supabaseAI) {
          console.log('üîå Creando SupabaseAI...');
          window.supabaseAI = new SupabaseAIIntegration();
        }
        
        if (!window.vocabularyManager) {
          console.log('üîå Creando VocabularyManager...');
          window.vocabularyManager = new VocabularyManager();
        }
        
        // Crea RequestMiddleware se mancante
        if (!window.requestMiddleware && window.RequestMiddleware) {
          console.log('üîå Creando RequestMiddleware...');
          window.requestMiddleware = new RequestMiddleware(window.supabaseAI);
        }
        
        // Crea AIMiddleware se mancante
        if (!window.aiMiddleware && window.AIMiddleware) {
          console.log('üîå Creando AIMiddleware...');
          window.aiMiddleware = new AIMiddleware();
        }
        
        // Riavvia il middleware
        if (window.middlewareIntegration) {
          console.log('üîå Riavviando middleware esistente...');
          window.middlewareIntegration.restart();
        } else {
          console.log('üîå Creando nuovo middleware...');
          window.middlewareIntegration = new MiddlewareIntegration();
        }
        
        alert('‚úÖ Middleware riavviato! Prova ora i comandi vocali.');
        
      } catch (error) {
        console.error('‚ùå Errore riavvio middleware:', error);
        alert('‚ùå Errore riavvio middleware: ' + error.message);
      }
    }
    
    // Aggiorna info debug
    function updateDebugInfo() {
      const debugInfo = document.getElementById('debug-info');
      if (!debugInfo) return;
      
      const isIPad = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                    (/Macintosh/.test(navigator.userAgent) && 'ontouchend' in document) ||
                    (navigator.maxTouchPoints && navigator.maxTouchPoints > 2) ||
                    (navigator.maxTouchPoints > 0 && /Mobile/.test(navigator.userAgent)) ||
                    localStorage.getItem('force_ipad_mode') === 'true';
      
      debugInfo.innerHTML = `
        <div><strong>User Agent:</strong><br>${navigator.userAgent}</div><br>
        <div><strong>maxTouchPoints:</strong> ${navigator.maxTouchPoints}</div>
        <div><strong>Mobile test:</strong> ${/Mobile/.test(navigator.userAgent)}</div>
        <div><strong>Force flag:</strong> ${localStorage.getItem('force_ipad_mode')}</div>
        <div><strong>üéØ iPad rilevato:</strong> <span style="color: ${isIPad ? 'lime' : 'red'}">${isIPad}</span></div>
        <div><strong>iosTTSManager:</strong> <span style="color: ${window.iosTTSManager ? 'lime' : 'red'}">${!!window.iosTTSManager}</span></div>
      `;
    }
    
    // Mostra pannello debug automaticamente su dispositivi mobili
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(() => {
        if (navigator.maxTouchPoints > 0 || /Mobile/.test(navigator.userAgent)) {
          document.getElementById('ipad-debug-panel').style.display = 'block';
          updateDebugInfo();
          
          // Aggiorna ogni 2 secondi
          setInterval(updateDebugInfo, 2000);
        }
      }, 3000);
    });
    
    // Aggiungi gesture per mostrare pannello (triplo tap)
    let tapCount = 0;
    document.addEventListener('touchstart', function(e) {
      if (e.touches.length === 3) {
        tapCount++;
        setTimeout(() => tapCount = 0, 1000);
        
        if (tapCount === 3) {
          toggleDebugPanel();
          updateDebugInfo();
        }
      }
    });
  </script>

  <div id="app-container">
    <!-- Header -->
    <header id="app-header">
      <h1>Gestione Commerciale Mobile</h1>
      <div class="header-datetime">
        <div id="dateDisplay" class="header-date">Caricamento data...</div>
        <div id="staticClock" class="header-clock">--:--:--</div>
      </div>
    </header>
    
    <!-- Pannello Debug iPad -->
    <div id="ipad-debug-panel" style="display: block; position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.9); color: white; padding: 15px; border-radius: 8px; z-index: 10000; font-family: monospace; font-size: 12px; max-width: 300px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <strong>üîç iPad Debug Panel</strong>
        <button onclick="toggleDebugPanel()" style="background: red; color: white; border: none; padding: 2px 8px; border-radius: 4px;">‚úï</button>
      </div>
      <div id="debug-info"></div>
      <div style="margin-top: 10px;">
        <button onclick="forceIPadMode()" style="background: #007bff; color: white; border: none; padding: 5px 10px; border-radius: 4px; margin-right: 5px;">Force iPad</button>
        <button onclick="testTTS()" style="background: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 4px;">Test TTS</button>
      </div>
      <div style="margin-top: 10px;">
        <h4 style="margin: 5px 0; font-size: 11px;">üîä Test Voci:</h4>
        <button onclick="testVoiceCosimo()" style="background: #6f42c1; color: white; border: none; padding: 3px 8px; border-radius: 3px; margin: 2px; font-size: 10px;">Cosimo</button>
        <button onclick="testVoiceElsa()" style="background: #6f42c1; color: white; border: none; padding: 3px 8px; border-radius: 3px; margin: 2px; font-size: 10px;">Elsa</button>
        <button onclick="testVoiceGoogle()" style="background: #6f42c1; color: white; border: none; padding: 3px 8px; border-radius: 3px; margin: 2px; font-size: 10px;">Google</button>
        <button onclick="testVoiceDaria()" style="background: #e74c3c; color: white; border: none; padding: 3px 8px; border-radius: 3px; margin: 2px; font-size: 10px;">Daria</button>
        <button onclick="showAllVoices()" style="background: #17a2b8; color: white; border: none; padding: 3px 8px; border-radius: 3px; margin: 2px; font-size: 10px;">Mostra Tutte</button>
      </div>
      <div style="margin-top: 10px;">
        <h4 style="margin: 5px 0; font-size: 11px;">üîä Test Volume:</h4>
        <button onclick="testVolumeMax()" style="background: #dc3545; color: white; border: none; padding: 3px 8px; border-radius: 3px; margin: 2px; font-size: 10px;">Volume Max</button>
        <button onclick="testSlowSpeech()" style="background: #fd7e14; color: white; border: none; padding: 3px 8px; border-radius: 3px; margin: 2px; font-size: 10px;">Lento</button>
      </div>
      <div style="margin-top: 10px;">
        <h4 style="margin: 5px 0; font-size: 11px;">üîå Debug Middleware:</h4>
        <button onclick="checkMiddlewareStatus()" style="background: #17a2b8; color: white; border: none; padding: 3px 8px; border-radius: 3px; margin: 2px; font-size: 10px;">Stato</button>
        <button onclick="restartMiddleware()" style="background: #ffc107; color: black; border: none; padding: 3px 8px; border-radius: 3px; margin: 2px; font-size: 10px;">Riavvia</button>
      </div>
    </div>

    <!-- Navigation Tabs -->
    <nav id="main-navigation" class="tabs">
      <div id="tab-timeline" class="tab-link active" data-target="timeline-content">Timeline</div>
      <div id="tab-data" class="tab-link" data-target="data-content">Gestione Dati</div>
      <div id="tab-demo" class="tab-link" data-target="demo-content" style="display: block !important; visibility: visible !important; opacity: 1 !important; background: linear-gradient(135deg, #00b894, #00a085) !important; color: white !important; font-weight: bold !important; border: 3px solid #ff6b6b !important; box-shadow: 0 4px 15px rgba(255,107,107,0.5) !important;">üáÆüáπ Demo Date</div>
      <div id="tab-planner" class="tab-link" data-target="planner-content">Pianificazione</div>
      <div id="tab-clients" class="tab-link" data-target="clients-content">Clienti</div>
      <div id="tab-travels" class="tab-link" data-target="travels-content">Percorsi</div>
      <div id="tab-worksheet" class="tab-link" data-target="worksheet-content">Foglio di Lavoro</div>
      <div id="tab-orders" class="tab-link" data-target="orders-content">Ordini</div>
      <div id="tab-ddtft" class="tab-link" data-target="ddtft-content">DDT e FT</div>
      <div id="tab-comandi" class="tab-link" data-target="comandi-content">‚öôÔ∏è Comandi</div>
      <div id="tab-smart" class="tab-link" data-target="smart-content">üé§ Smart Assistant</div>
      <div id="tab-ai" class="tab-link" data-target="ai-content">ü§ñ AI Assistant</div>
    </nav>

    <!-- Main Content Area -->
    <main id="main-content">
      <!-- Timeline Tab -->
      <div id="timeline-content" class="tab-content active">
        <!-- Content will be loaded dynamically -->
      </div>

      <!-- Data Management Tab -->
      <div id="data-content" class="tab-content">
        <!-- Content will be loaded dynamically -->
      </div>

      <!-- Planning Tab -->
      <div id="planner-content" class="tab-content">
        <!-- Content will be loaded dynamically -->
      </div>

      <!-- Clients Tab -->
      <div id="clients-content" class="tab-content">
        <!-- Content will be loaded dynamically -->
      </div>

      <!-- Routes Tab -->
      <div id="travels-content" class="tab-content">
        <!-- Content will be loaded dynamically -->
      </div>

      <!-- Worksheet Tab -->
      <div id="worksheet-content" class="tab-content">
        <!-- Content will be loaded dynamically -->
      </div>

      <!-- Orders Tab -->
      <div id="orders-content" class="tab-content">
        <!-- Content will be loaded dynamically -->
      </div>

      <!-- DDT/FT Tab -->
      <div id="ddtft-content" class="tab-content">
        <!-- Content will be loaded dynamically -->
      </div>

      <!-- COMANDI TAB -->
      <div id="comandi-content" class="tab-content">
        <!-- Contenuto Comandi verr√† caricato dinamicamente -->
      </div>

      <!-- SMART ASSISTANT TAB -->
      <div id="smart-content" class="tab-content">
        <!-- Contenuto Smart Assistant verr√† caricato dinamicamente -->
      </div>

      <!-- NUOVO TAB AI -->
      <div id="ai-content" class="tab-content">
        <!-- Contenuto AI verr√† caricato dinamicamente -->
        <div style="padding: 20px;">
          <h3>ü§ñ Assistente AI - Gestione Provider</h3>
          
          <!-- Controlli Provider -->
          <div style="margin: 20px 0; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h4>üîß Configurazione Provider</h4>
            <div style="margin: 15px 0;">
              <label>Seleziona Provider AI:</label>
              <select id="ai-provider-select" style="margin: 10px 0; padding: 8px; width: 200px; border: 1px solid #ddd; border-radius: 4px;" onchange="loadAvailableModels()">
                <option value="">Seleziona...</option>
                <option value="anthropic">Anthropic Claude</option>
                <option value="openai">OpenAI GPT</option>
              </select>
              <button onclick="changeAIProvider()" class="btn btn-primary" style="margin-left: 10px;">Cambia Provider</button>
            </div>
            
            <div id="model-selection" style="margin: 15px 0; display: none;">
              <label>Seleziona Modello:</label>
              <select id="ai-model-select" onchange="autoChangeModel()" style="margin: 10px 0; padding: 8px; width: 300px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="">Seleziona un modello...</option>
              </select>
              <button onclick="changeAIModel()" class="btn btn-secondary" style="margin-left: 10px;">Cambia Modello</button>
            </div>
            
            <div id="ai-provider-status" style="margin-top: 10px; padding: 10px; border-radius: 4px; background: #f8f9fa;"></div>
          </div>

          <!-- Info API Keys -->
          <div style="margin: 20px 0; padding: 15px; background: #d4edda; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h4>‚úÖ API Keys</h4>
            <div style="margin: 10px 0;">
              <strong>Status:</strong> API keys gi√† configurate nel sistema.
            </div>
            <div style="margin: 10px 0;">
              <strong>Provider supportati:</strong> OpenAI GPT e Anthropic Claude
            </div>
          </div>

          <!-- Test Connessione -->
          <div style="margin: 20px 0; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h4>üß™ Test Connessione</h4>
            <div style="margin: 15px 0;">
              <button onclick="testCurrentProvider()" class="btn btn-info" style="margin-right: 10px;">Test Provider Corrente</button>
              <button onclick="testAllProviders()" class="btn btn-secondary">Test Tutti i Provider</button>
            </div>
            <div id="test-results" style="margin-top: 10px; padding: 10px; border-radius: 4px; background: #f8f9fa;"></div>
          </div>

          <!-- Statistiche Provider -->
          <div style="margin: 20px 0; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <h4 style="margin: 0;">üìä Statistiche Provider Corrente</h4>
              <button onclick="window.updateProviderStats()" style="padding: 8px 15px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">üîÑ Aggiorna Stats</button>
            </div>
            <div id="provider-stats" style="margin-top: 10px; padding: 10px; border-radius: 4px; background: #f8f9fa;"></div>
          </div>

          <!-- Chat AI -->
          <div style="margin: 20px 0; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <h4 style="margin: 0;">üí¨ Chat AI</h4>
              <button onclick="clearAIChat()" style="padding: 8px 15px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">üóëÔ∏è Cancella Chat</button>
            </div>
            <div id="ai-messages" style="height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px; margin: 10px 0; background: #f8f9fa;"></div>
            <div style="display: flex; gap: 10px;">
              <input type="text" id="ai-input" placeholder="Scrivi il tuo messaggio..." style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" onkeypress="if(event.key==='Enter') sendAIMessage()">
              <button onclick="sendAIMessage()" class="btn btn-primary">Invia</button>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB DEMO DATE ITALIANE -->
      <div id="demo-content" class="tab-content">
        <div style="padding: 20px;">
          <h3>üáÆüáπ Sistema Date Italiano - Demo Interattiva</h3>
          
          <!-- Test Veloce -->
          <div style="margin: 20px 0; text-align: center;">
            <button onclick="testItalianDateSystem()" class="btn btn-info" style="padding: 12px 30px; font-size: 16px;">
              ‚ö° Test Sistema Date Italiano
            </button>
          </div>
          
          <div id="quick-test-results" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px; display: none;">
            <h4>Risultati Test:</h4>
            <div id="test-output"></div>
          </div>

          <!-- Demo Validazione Date -->
          <div style="margin: 30px 0; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h4>üìÖ Validazione Date Italiane</h4>
            <div style="margin: 15px 0;">
              <label>Inserisci una data (formato DD/MM/YYYY):</label>
              <input type="text" id="dateInput" placeholder="es. 15/03/2025" style="margin: 10px 0; padding: 10px; width: 200px; border: 1px solid #ddd; border-radius: 4px;">
              <button onclick="validateDateDemo()" class="btn btn-primary" style="margin-left: 10px;">Valida</button>
            </div>
            <div id="dateValidationResult" style="margin-top: 10px; padding: 10px; border-radius: 4px;"></div>
          </div>

          <!-- Demo Conversione Date -->
          <div style="margin: 30px 0; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h4>üîÑ Conversione Date</h4>
            <div style="margin: 15px 0;">
              <label>Data italiana da convertire:</label>
              <input type="text" id="conversionInput" placeholder="es. 25/12/2025" style="margin: 10px 0; padding: 10px; width: 200px; border: 1px solid #ddd; border-radius: 4px;">
              <button onclick="convertDateDemo()" class="btn btn-primary" style="margin-left: 10px;">Converti</button>
            </div>
            <div id="conversionResult" style="margin-top: 10px; padding: 10px; border-radius: 4px;"></div>
          </div>

          <!-- Demo Calcoli -->
          <div style="margin: 30px 0; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h4>üßÆ Calcoli con Date</h4>
            <div style="margin: 15px 0;">
              <div style="margin: 10px 0;">
                <label>Data inizio:</label>
                <input type="text" id="startDate" placeholder="01/01/2025" style="margin: 5px; padding: 8px; width: 150px; border: 1px solid #ddd; border-radius: 4px;">
              </div>
              <div style="margin: 10px 0;">
                <label>Data fine:</label>
                <input type="text" id="endDate" placeholder="31/12/2025" style="margin: 5px; padding: 8px; width: 150px; border: 1px solid #ddd; border-radius: 4px;">
              </div>
              <button onclick="calculateDaysDemo()" class="btn btn-primary">Calcola Giorni</button>
              <button onclick="calculateWorkingDaysDemo()" class="btn btn-secondary" style="margin-left: 10px;">Giorni Lavorativi</button>
            </div>
            <div id="calculationResult" style="margin-top: 10px; padding: 10px; border-radius: 4px;"></div>
          </div>

          <!-- Demo Festivit√† -->
          <div style="margin: 30px 0; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h4>üéâ Verifica Festivit√†</h4>
            <div style="margin: 15px 0;">
              <label>Verifica se una data √® festiva:</label>
              <input type="text" id="holidayInput" placeholder="25/12/2025" style="margin: 10px 0; padding: 10px; width: 200px; border: 1px solid #ddd; border-radius: 4px;">
              <button onclick="checkHolidayDemo()" class="btn btn-primary" style="margin-left: 10px;">Verifica</button>
            </div>
            <div id="holidayResult" style="margin-top: 10px; padding: 10px; border-radius: 4px;"></div>
          </div>

          <!-- Link ai File Completi -->
          <div style="margin: 30px 0; padding: 20px; background: #e3f2fd; border-radius: 8px;">
            <h4>üìÅ Demo e Test Completi</h4>
            <p>Per demo pi√π avanzate e test completi:</p>
            <div style="margin: 15px 0;">
              <a href="demo-italian-dates.html" target="_blank" class="btn btn-primary" style="margin-right: 10px;">
                üì± Demo Completa
              </a>
              <a href="test-italian-dates.html" target="_blank" class="btn btn-secondary">
                üß™ Test Suite Completa
              </a>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Debug Info (hidden by default) -->
    <div id="debug-info" style="display: none;"></div>
  </div>

  <!-- JavaScript Modules -->
  
  <!-- üîß SISTEMA CARICAMENTO ROBUSTO MODULI JAVASCRIPT -->
  <script>
    console.log('üöÄ Inizializzazione sistema caricamento moduli...');
    
    // 1. SISTEMA DI CARICAMENTO ROBUSTO
    window.ModuleLoader = {
      loadedModules: new Set(),
      failedModules: new Set(),
      
      loadScript: async function(src, required = false) {
        if (this.loadedModules.has(src)) {
          console.log('‚úÖ Modulo gi√† caricato:', src);
          return true;
        }
        
        try {
          console.log('üîÑ Caricamento modulo:', src);
          
          const response = await fetch(src);
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          
          const contentType = response.headers.get('content-type') || '';
          if (!contentType.includes('javascript') && !contentType.includes('text/plain')) {
            const text = await response.text();
            if (text.trim().startsWith('<!DOCTYPE') || text.includes('<html')) {
              throw new Error('Server restituisce HTML invece di JavaScript');
            }
          }
          
          const script = document.createElement('script');
          script.src = src;
          script.defer = true;
          
          // CRITICAL FIX: Rileva moduli ES6 e imposta type="module"
          const isES6Module = src.includes('temporal') || 
                             src.includes('middleware') ||
                             src.includes('semantic') ||
                             src.includes('parser') ||
                             /\.(mjs|module\.js)$/.test(src);
          
          if (isES6Module) {
            script.type = 'module';
            console.log('üì¶ Caricamento modulo ES6 in ModuleLoader:', src);
          }
          
          return new Promise((resolve, reject) => {
            script.onload = () => {
              this.loadedModules.add(src);
              console.log('‚úÖ Caricato:', src);
              resolve(true);
            };
            
            script.onerror = (error) => {
              this.failedModules.add(src);
              console.error('‚ùå Errore caricamento:', src, error);
              if (required) {
                reject(error);
              } else {
                resolve(false);
              }
            };
            
            document.head.appendChild(script);
          });
          
        } catch (error) {
          this.failedModules.add(src);
          console.error('‚ùå Errore fetch:', src, error.message);
          
          if (required) {
            throw error;
          }
          return false;
        }
      }
    };
    
    // 2. SISTEMA DATE ITALIANO - FUNZIONI BASE
    window.ItalianDateSystem = window.ItalianDateSystem || {
      formatDateItalian: function(date) {
        if (!date) return '';
        const d = new Date(date);
        return d.getDate().toString().padStart(2, '0') + '/' + 
               (d.getMonth() + 1).toString().padStart(2, '0') + '/' + 
               d.getFullYear();
      },
      parseItalianDate: function(dateStr) {
        if (!dateStr) return null;
        const parts = dateStr.split('/');
        if (parts.length === 3) {
          return new Date(parts[2], parts[1] - 1, parts[0]);
        }
        return null;
      },
      isValidItalianDate: function(dateStr) {
        const date = this.parseItalianDate(dateStr);
        return date && !isNaN(date.getTime());
      },
      testParser: function() {
        console.log('üß™ Test parser date italiane:');
        console.log('25/12/2025 ->', this.parseItalianDate('25/12/2025'));
        console.log('01/01/2025 ->', this.parseItalianDate('01/01/2025'));
        return 'Test completato - controlla console';
      }
    };
    
    // 3. CONFIGURAZIONE TEMPORALE BASE
    window.TEMPORAL_CONFIG = window.TEMPORAL_CONFIG || {
      locale: 'it-IT',
      timezone: 'Europe/Rome',
      dateFormat: 'DD/MM/YYYY'
    };
    
    // 4. FUNZIONI GLOBALI DEMO
    window.testItalianDateSystem = function() {
      return window.ItalianDateSystem.testParser();
    };
    
    console.log('‚úÖ Sistema base moduli inizializzato');
    
    // === FUNZIONI GESTIONE PROVIDER AI ===
    
    window.changeAIProvider = function() {
      const select = document.getElementById('ai-provider-select');
      const providerId = select.value;
      const statusDiv = document.getElementById('ai-provider-status');
      
      if (!providerId) {
        statusDiv.innerHTML = '<span style="color: red;">‚ö†Ô∏è Seleziona un provider</span>';
        return;
      }
      
      if (window.FlavioAIAssistant) {
        const success = window.FlavioAIAssistant.changeProvider(providerId);
        if (success) {
          statusDiv.innerHTML = `<span style="color: green;">‚úÖ Provider cambiato a: ${providerId}</span>`;
          window.updateProviderStats();
          window.loadAvailableModels();
        } else {
          statusDiv.innerHTML = `<span style="color: red;">‚ùå Errore cambio provider: ${providerId}</span>`;
        }
      } else {
        statusDiv.innerHTML = '<span style="color: red;">‚ùå FlavioAIAssistant non disponibile</span>';
      }
    };

    window.loadAvailableModels = function() {
      const providerSelect = document.getElementById('ai-provider-select');
      const modelSelect = document.getElementById('ai-model-select');
      const modelDiv = document.getElementById('model-selection');
      const providerId = providerSelect.value;
      
      if (!providerId) {
        modelDiv.style.display = 'none';
        return;
      }
      
      // Attiva automaticamente il provider selezionato
      if (window.FlavioAIAssistant) {
        const success = window.FlavioAIAssistant.changeProvider(providerId);
        console.log(`üîß Provider ${providerId} ${success ? 'attivato' : 'errore attivazione'}`);
        
        // ‚úÖ SINCRONIZZA IL MODELLO PRINCIPALE
        const mainModelSelect = document.getElementById('ai-model');
        if (mainModelSelect) {
          // ‚úÖ NON FORZA IL MODELLO - MANTIENI LA SELEZIONE DELL'UTENTE
          // Solo se non c'√® gi√† un modello selezionato, usa il default
          if (!mainModelSelect.value || mainModelSelect.value === '') {
            if (providerId === 'openai') {
              mainModelSelect.value = 'gpt-4'; // Modello OpenAI predefinito
            } else if (providerId === 'anthropic') {
              mainModelSelect.value = 'claude-3-5-sonnet-20241022'; // Modello Anthropic predefinito
            }
            console.log('üîÑ Modello principale sincronizzato (solo se vuoto):', mainModelSelect.value);
          } else {
            console.log('üîÑ Modello principale mantenuto (utente ha gi√† selezionato):', mainModelSelect.value);
            
            // ‚úÖ AGGIORNA IL MODELLO NEL PROVIDER CON LA SELEZIONE CORRENTE
            const selectedModel = mainModelSelect.value;
            if (providerId === 'openai' && window.OpenAI) {
              window.OpenAI.setModel(selectedModel);
              console.log('‚úÖ Modello OpenAI sincronizzato con UI:', selectedModel);
            } else if (providerId === 'anthropic' && window.AnthropicAI) {
              window.AnthropicAI.setModel(selectedModel);
              console.log('‚úÖ Modello Anthropic sincronizzato con UI:', selectedModel);
            }
            
            // ‚úÖ AGGIORNA IMMEDIATAMENTE LE STATISTICHE
            setTimeout(() => {
              if (window.updateProviderStats) {
                window.updateProviderStats();
                console.log('üìä Statistiche aggiornate dopo cambio provider');
              }
            }, 100);
          }
        }
      }
      
      // Pulisci opzioni precedenti
      modelSelect.innerHTML = '<option value="">Seleziona un modello...</option>';
      
      let models = {};
      
      if (providerId === 'anthropic' && window.AnthropicAI) {
        models = window.AnthropicAI.getAvailableModels();
      } else if (providerId === 'openai' && window.OpenAI) {
        models = window.OpenAI.getAvailableModels();
      }
      
      // Popola le opzioni
      for (const [modelId, modelInfo] of Object.entries(models)) {
        const option = document.createElement('option');
        option.value = modelId;
        option.textContent = `${modelInfo.name} - ${modelInfo.description}`;
        modelSelect.appendChild(option);
      }
      
      modelDiv.style.display = 'block';
      
      // Aggiorna le statistiche del provider
      window.updateProviderStats();
    };

    // ‚úÖ FUNZIONE AUTOMATICA: Cambia modello appena selezionato
    window.autoChangeModel = function() {
      console.log('üîÑ Auto-cambio modello attivato');
      changeAIModel();
      
      // Aggiorna subito le statistiche
      setTimeout(() => {
        if (window.updateProviderStats) {
          window.updateProviderStats();
          console.log('üìä Statistiche aggiornate dopo cambio automatico modello');
        }
      }, 100);
    };

    window.changeAIModel = function() {
      const modelSelect = document.getElementById('ai-model-select');
      const providerSelect = document.getElementById('ai-provider-select');
      const statusDiv = document.getElementById('ai-provider-status');
      const modelId = modelSelect.value;
      const providerId = providerSelect.value;
      
      if (!modelId) {
        statusDiv.innerHTML = '<span style="color: red;">‚ö†Ô∏è Seleziona un modello</span>';
        return;
      }
      
      let success = false;
      
      // Assicurati che il provider sia attivo
      if (window.FlavioAIAssistant) {
        window.FlavioAIAssistant.changeProvider(providerId);
      }
      
      if (providerId === 'anthropic' && window.AnthropicAI) {
        success = window.AnthropicAI.setModel(modelId);
      } else if (providerId === 'openai' && window.OpenAI) {
        success = window.OpenAI.setModel(modelId);
      }
      
      if (success) {
        statusDiv.innerHTML = `<span style="color: green;">‚úÖ Modello cambiato a: ${modelId}</span>`;
        window.updateProviderStats();
      } else {
        statusDiv.innerHTML = `<span style="color: red;">‚ùå Errore cambio modello: ${modelId}</span>`;
      }
    };
    
    window.setAnthropicApiKey = function() {
      const input = document.getElementById('anthropic-api-key');
      const apiKey = input.value.trim();
      
      if (!apiKey) {
        alert('Inserisci una API key valida');
        return;
      }
      
      if (window.FlavioAIAssistant) {
        const success = window.FlavioAIAssistant.setApiKey('anthropic', apiKey);
        if (success) {
          input.value = '';
          alert('‚úÖ API Key Anthropic configurata');
        } else {
          alert('‚ùå Errore configurazione API Key');
        }
      }
    };
    
    window.setOpenAIApiKey = function() {
      const input = document.getElementById('openai-api-key');
      const apiKey = input.value.trim();
      
      if (!apiKey) {
        alert('Inserisci una API key valida');
        return;
      }
      
      if (window.FlavioAIAssistant) {
        const success = window.FlavioAIAssistant.setApiKey('openai', apiKey);
        if (success) {
          input.value = '';
          alert('‚úÖ API Key OpenAI configurata');
        } else {
          alert('‚ùå Errore configurazione API Key');
        }
      }
    };
    
    window.testCurrentProvider = async function() {
      const resultsDiv = document.getElementById('test-results');
      resultsDiv.innerHTML = 'üß™ Test in corso...';
      
      try {
        if (window.FlavioAIAssistant && window.FlavioAIAssistant.baseAssistant) {
          const success = await window.FlavioAIAssistant.baseAssistant.testProvider();
          if (success) {
            resultsDiv.innerHTML = '<span style="color: green;">‚úÖ Test provider corrente riuscito</span>';
          } else {
            resultsDiv.innerHTML = '<span style="color: red;">‚ùå Test provider corrente fallito</span>';
          }
        } else {
          resultsDiv.innerHTML = '<span style="color: red;">‚ùå Sistema AI non disponibile</span>';
        }
      } catch (error) {
        resultsDiv.innerHTML = `<span style="color: red;">‚ùå Errore test: ${error.message}</span>`;
      }
    };
    
    window.testAllProviders = async function() {
      const resultsDiv = document.getElementById('test-results');
      resultsDiv.innerHTML = 'üß™ Test di tutti i provider in corso...';
      
      try {
        if (window.FlavioAIAssistant) {
          const providers = window.FlavioAIAssistant.getAvailableProviders();
          let results = '<h5>Risultati Test:</h5>';
          
          for (const provider of providers) {
            results += `<div style="margin: 5px 0;">`;
            try {
              const success = await window.FlavioAIAssistant.testProvider(provider.id);
              results += success ? 
                `<span style="color: green;">‚úÖ ${provider.name}: OK</span>` :
                `<span style="color: red;">‚ùå ${provider.name}: FALLITO</span>`;
            } catch (error) {
              results += `<span style="color: red;">‚ùå ${provider.name}: ${error.message}</span>`;
            }
            results += `</div>`;
          }
          
          resultsDiv.innerHTML = results;
        } else {
          resultsDiv.innerHTML = '<span style="color: red;">‚ùå Sistema AI non disponibile</span>';
        }
      } catch (error) {
        resultsDiv.innerHTML = `<span style="color: red;">‚ùå Errore test: ${error.message}</span>`;
      }
    };
    
    window.updateProviderStats = function() {
      console.log('üîÑ REFRESH STATS CHIAMATO');
      const statsDiv = document.getElementById('provider-stats');
      
      if (!statsDiv) {
        console.error('‚ùå Elemento provider-stats non trovato');
        return;
      }
      
      if (window.FlavioAIAssistant) {
        const stats = window.FlavioAIAssistant.getProviderStats();
        console.log('üìä Stats ottenute:', stats);
        
        if (stats) {
          // Calcola token utilizzati dalla session storage
          const totalTokens = parseInt(sessionStorage.getItem('total_tokens_used') || '0');
          const lastRequestTokens = parseInt(sessionStorage.getItem('last_request_tokens') || '0');
          
          // Calcola costi approssimativi
          const provider = stats.provider?.toLowerCase() || 'openai';
          const modelName = stats.model || 'gpt-3.5-turbo';
          
          const lastCost = window.calculateAICost(lastRequestTokens, modelName, provider);
          const totalCost = window.calculateAICost(totalTokens, modelName, provider);
          
          // Ottieni dati giornalieri
          const dailyStats = window.getDailyStats();
          
          statsDiv.innerHTML = `
            <h5>Provider Corrente:</h5>
            <div><strong>Nome:</strong> ${stats.provider || 'N/A'}</div>
            <div><strong>Modello:</strong> ${stats.model || 'N/A'}</div>
            <div><strong>Max Tokens:</strong> ${stats.maxTokens || 'N/A'}</div>
            <div><strong>Temperature:</strong> ${stats.temperature || 'N/A'}</div>
            <div><strong>Inizializzato:</strong> ${stats.isInitialized ? '‚úÖ' : '‚ùå'}</div>
            
            <div style="border-top: 1px solid #eee; margin-top: 10px; padding-top: 10px;">
              <strong>üìä Token Utilizzati:</strong>
              <div style="margin-left: 20px;">
                <div>Ultima richiesta: ${lastRequestTokens} token</div>
                <div>Totale sessione: ${totalTokens} token</div>
                <div style="color: #fd7e14;"><strong>Totale giornata:</strong> ${dailyStats.totalTokens} token</div>
              </div>
            </div>
            
            <div style="border-top: 1px solid #eee; margin-top: 10px; padding-top: 10px;">
              <strong>üí∞ Costo Approssimativo:</strong>
              <div style="margin-left: 20px;">
                <div style="color: #28a745;">
                  <strong>Ultima richiesta:</strong> 
                  ‚Ç¨${lastCost.eur ? lastCost.eur.toFixed(4) : '0.0000'}
                </div>
                <div style="color: #17a2b8;">
                  <strong>Totale sessione:</strong> 
                  ‚Ç¨${totalCost.eur ? totalCost.eur.toFixed(4) : '0.0000'}
                </div>
                <div style="color: #fd7e14;">
                  <strong>Totale giornata:</strong> 
                  ‚Ç¨${dailyStats.totalCostEUR ? dailyStats.totalCostEUR.toFixed(4) : '0.0000'}
                </div>
                <div style="font-size: 12px; color: #6c757d; margin-top: 5px;">
                  <em>Prezzi approssimativi in EUR (cambio USD/EUR ~0.85)</em>
                </div>
                <div style="font-size: 12px; color: #6c757d;">
                  <em>Interazioni oggi: ${dailyStats.interactions || 0}</em>
                </div>
              </div>
            </div>
          `;
          console.log('‚úÖ Stats aggiornate con successo');
        } else {
          statsDiv.innerHTML = '<span style="color: gray;">Nessun provider attivo</span>';
        }
      } else {
        statsDiv.innerHTML = '<span style="color: red;">Sistema AI non disponibile</span>';
      }
    };

    // Inizializza l'interfaccia AI quando la pagina √® caricata
    window.addEventListener('load', function() {
      setTimeout(function() {
        const providerSelect = document.getElementById('ai-provider-select');
        if (providerSelect) {
          // Se non c'√® un provider selezionato, seleziona il primo disponibile
          if (!providerSelect.value && providerSelect.options.length > 1) {
            providerSelect.value = providerSelect.options[1].value; // Primo provider (skip "Seleziona...")
          }
          
          if (providerSelect.value) {
            window.loadAvailableModels();
          }
        }
      }, 2000);
    });
    
    window.sendAIMessage = function() {
      const input = document.getElementById('ai-input');
      const message = input.value.trim();
      
      if (!message) return;
      
      if (window.FlavioAIAssistant) {
        window.FlavioAIAssistant.sendMessage(message);
        input.value = '';
      } else {
        alert('Sistema AI non disponibile');
      }
    };
    
    // Auto-update stats on page load
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(() => {
        if (window.updateProviderStats) {
          window.updateProviderStats();
        }
      }, 2000);
    });
    
    // üß™ SISTEMA DI TEST E DIAGNOSTIC
    window.SystemDiagnostic = {
      runTests: function() {
        console.log('üß™ === DIAGNOSTIC SISTEMA ===');
        
        const tests = [
          {
            name: 'ModuleLoader',
            test: () => typeof window.ModuleLoader === 'object' && typeof window.ModuleLoader.loadScript === 'function'
          },
          {
            name: 'ItalianDateSystem',
            test: () => typeof window.ItalianDateSystem === 'object' && typeof window.ItalianDateSystem.formatDateItalian === 'function'
          },
          {
            name: 'SupabaseConfig',
            test: () => typeof window.SUPABASE_CONFIG === 'object'
          },
          {
            name: 'Navigation',
            test: () => typeof window.Navigation === 'object' && typeof window.Navigation.switchToTab === 'function'
          },
          {
            name: 'DemoTab',
            test: () => {
              const demoTab = document.getElementById('tab-demo');
              return demoTab && demoTab.style.display !== 'none';
            }
          },
          {
            name: 'ClearHistoryFunction',
            test: () => typeof window.clearAIChatHistory === 'function'
          }
        ];
        
        let passed = 0;
        let failed = 0;
        
        tests.forEach(test => {
          try {
            const result = test.test();
            if (result) {
              console.log(`‚úÖ ${test.name}: PASS`);
              passed++;
            } else {
              console.log(`‚ùå ${test.name}: FAIL`);
              failed++;
            }
          } catch (error) {
            console.log(`‚ùå ${test.name}: ERROR -`, error.message);
            failed++;
          }
        });
        
        console.log(`üèÅ Test completati: ${passed} passed, ${failed} failed`);
        return { passed, failed, total: tests.length };
      },
      
      checkErrors: function() {
        console.log('üîç === CONTROLLO ERRORI COMUNI ===');
        
        // Controlla errori JavaScript
        const errors = [];
        
        if (typeof window.supabase === 'undefined' && typeof window.supabaseClient === 'undefined') {
          errors.push('Supabase non inizializzato');
        }
        
        const demoTab = document.getElementById('tab-demo');
        if (!demoTab) {
          errors.push('Tab demo non trovato');
        } else if (demoTab.style.display === 'none') {
          errors.push('Tab demo nascosto');
        }
        
        if (typeof window.Navigation !== 'object') {
          errors.push('Sistema Navigation non caricato');
        }
        
        if (errors.length === 0) {
          console.log('‚úÖ Nessun errore rilevato');
        } else {
          console.log('‚ùå Errori rilevati:', errors);
        }
        
        return errors;
      }
    };
    
    // Auto-test quando la pagina √® caricata completamente
    window.addEventListener('load', function() {
      setTimeout(() => {
        console.log('üöÄ === AUTO-DIAGNOSTIC AVVIATO ===');
        window.SystemDiagnostic.runTests();
        window.SystemDiagnostic.checkErrors();
        console.log('üí° Usa SystemDiagnostic.runTests() per test manuali');
      }, 3000);
    });
    
    console.log('‚úÖ Sistema diagnostic configurato');
  </script>
  
  <!-- SafeLoad 2.0 System -->
  <script src="js/modules/ddtft/loader.js"></script>
  <!-- ‚ö° Bootstrap ottimizzato - Ridotte 16 catene a 4 step con caricamento parallelo -->
  <script>
    // üöÄ CARICAMENTO OTTIMIZZATO - Core modules in parallelo, rimozione moduli non essenziali
    Promise.all([
      // Core essenziali (parallelo per velocit√†)
      safeLoadQueue('js/utils/italian-date-manager.js'),
      safeLoadQueue('js/middleware/vocabulary-manager.js'),
      safeLoadQueue('config/ai-config.js'),
      safeLoadQueue('js/ai/openai-ai.js'), // Riabilitato con controllo inizializzazione
      safeLoadQueue('js/ai/anthropic-ai.js'),
      safeLoadQueue('js/ai/ai-assistant.js'),
      safeLoadQueue('js/ai/ios-tts-fix.js'),
      safeLoadQueue('js/ai/flavio-ai-assistant.js'),
      safeLoadQueue('js/ai/supabase-ai-integration.js')
    ])
    .then(() => {
      // üîÑ CARICAMENTO MIDDLEWARE AI - Sistema di routing intelligente  
      console.log('üîÑ Caricamento middleware AI...');
      return safeLoadQueue(
        'js/ai-request-filter.js',  // NUOVO: Filtro AI per riduzione costi 95%
        // 'js/middleware/request-middleware.js', ‚úÖ RIMOSSO - Solo VocabularyManager attivo
        'js/middleware/ai-middleware.js',
        'js/middleware/robust-connection-manager.js',
        'js/middleware/middleware-integration.js'
      );
    })
    .then(() => Promise.all([
      // DDTFT modules (parallelo)
      safeLoadQueue(
        'js/config/ddtft-patterns.js',
        'js/config/ddtft-mappings.js',
        'js/utils/ddtft-parsing-utils.js',
        'js/utils/ddtft-address-utils.js',
        'js/utils/ddtft-product-utils.js',
        'js/utils/client-alias-resolver.js',
        'js/modules/ddtft/document-parser.js',
        'js/modules/ddtft-pdf-parser.js'
      ),
      // Supabase e config (parallelo) 
      safeLoad('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js')
        .then(() => safeLoadQueue(
          'config-modules.js',
          'config/api-config.js',
          'config/supabase-config.js',
          'js/utils.js',
          'js/app.js',
          'js/navigation.js',
          'js/api.js'
        ))
    ]))
    .then(() => {
      // üöÄ CARICAMENTO RAPIDO: Solo moduli critici per interfaccia base
      console.log('‚ö° Caricamento moduli critici...');
      return safeLoadQueue(
        'js/timeline/timeline-config.js',
        'js/timeline/timeline-core.js',
        'js/clienti-core.js',
        'js/worksheet-core.js'
      );
    })
    .then(() => {
      console.log('‚úÖ UI base pronta - inizializzazione app...');
      // L'app ora pu√≤ inizializzarsi e mostrare l'interfaccia
      return Promise.resolve();
    })
    .then(() => safeLoadQueue(
      // Moduli essenziali per funzionalit√† di base
      'js/comandi-core.js',
      'js/comandi-ui.js'
    ))
    .then(() => {
      console.log('‚úÖ Bootstrap completo - UI pronta!');
      if (window.runSanity) window.runSanity();
      
      // üöÄ BACKGROUND LOADING: Carica moduli non critici in background
      setTimeout(() => {
        console.log('üîÑ Avvio caricamento background...');
        Promise.all([
          // Timeline completo
          safeLoadQueue(
            'js/timeline/timeline-utils.js',
            'js/timeline/timeline-rendering.js', 
            'js/timeline/timeline-events.js',
            'js/timeline/timeline-controls.js'
          ),
          // Business modules
          safeLoadQueue(
            'js/clienti-form.js',
            'js/ordini.js',
            'js/prodotti.js',
            'js/percorsi.js'
          ),
          // Worksheet completo  
          safeLoadQueue(
            'js/worksheet-data.js',
            'js/worksheet-ui.js',
            'js/worksheet-view.js',
            'js/worksheet-import.js',
            'js/worksheet-itinerary.js',
            'js/worksheet-dragdrop.js'
          ),
          // Utils e export
          safeLoadQueue(
            'js/clienti-table.js',
            'js/clienti-utils.js', 
            'js/clienti-import-export.js',
            'js/modules/ordini-parser.js',
            'js/modules/ordini-export-core.js'
          ),
          // DDTFT modules
          safeLoadQueue(
            'js/ddtft-core.js',
            'js/ddtft-view.js',
            'js/ddtft-create.js',
            'js/ddtft-import/ddtft-bundle.js',  // NUOVO: Bundle modulare ottimizzato
            'js/ddtft-filters.js',
            'js/ddtft-utils.js',
            'js/modules/ddtft-import-export.js',
            'js/modules/ddtft-export-advanced.js'
          ),
          // Features extra
          safeLoadQueue(
            'js/smart-assistant/smart-assistant-bundle.js',  // NUOVO: Bundle modulare ottimizzato
            'js/modules/smart-assistant-supabase.js',
            'js/modules/smart-assistant-secure-storage.js',
            'fix-smart-assistant-voice.js',
            'js/keep-alive.js'
          ),
          // üéôÔ∏è SISTEMA VOCALE (background loading)
          safeLoadQueue(
            'js/voice/voice-assistant.js',
            'js/ai/voice-recognition.js',
            'js/ai/ai-voice-manager.js'
          )
        ]).then(() => {
          console.log('üéâ Caricamento background completato!');
          
          // üîå AVVIO SISTEMA CONNESSIONE ROBUSTA
          setTimeout(() => {
            console.log('üîå Avvio sistema connessione robusta...');
            if (window.robustConnectionManager) {
              window.robustConnectionManager.start().then((connected) => {
                if (connected) {
                  console.log('üîå ‚úÖ Sistema connessione robusta attivo');
                } else {
                  console.log('üîå ‚ö†Ô∏è Sistema connessione robusta: connessione parziale');
                }
              });
            }
          }, 3000); // 3 secondi dopo il caricamento
        });
      }, 100); // Inizia subito dopo bootstrap
      
      // üö® FIX EMERGENZA: Ripristina navigazione immediatamente
      setTimeout(() => {
        console.log('üö® RIPRISTINO NAVIGAZIONE EMERGENZA...');
        
        // Rimuovi il forcing dal demo tab e ripristina click normale per tutti
        document.querySelectorAll('.tab-link').forEach(tab => {
          // Rimuovi eventuali event listener che bloccano
          const newTab = tab.cloneNode(true);
          tab.parentNode.replaceChild(newTab, tab);
          
          // Aggiungi click handler normale
          newTab.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Navigazione normale
            document.querySelectorAll('.tab-link').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            this.classList.add('active');
            const targetId = this.getAttribute('data-target');
            const targetContent = document.getElementById(targetId);
            if (targetContent) {
              targetContent.classList.add('active');
              console.log('üéØ Navigazione a:', targetId);
              
              // Inizializza modulo specifico quando entra nel tab
              if (targetId === 'comandi-content' && window.ComandiModule && typeof window.ComandiModule.onEnter === 'function') {
                console.log('‚öôÔ∏è Inizializzazione tab Comandi...');
                window.ComandiModule.onEnter();
              }
              
              if (targetId === 'ai-content' && window.FlavioAIAssistant) {
                console.log('ü§ñ Inizializzazione tab AI Assistant...');
                window.FlavioAIAssistant.renderInterface();
              }
              
              if (targetId === 'smart-content' && window.SmartAssistant) {
                console.log('üé§ Inizializzazione tab Smart Assistant...');
                window.SmartAssistant.render();
              }
            }
          });
        });
        
        console.log('‚úÖ NAVIGAZIONE RIPRISTINATA - Tutte le tab dovrebbero funzionare');
      }, 1000);
      
      // üö® FIX EMERGENZA: Inizializza contenuti tab
      setTimeout(() => {
        console.log('üö® INIZIALIZZAZIONE CONTENUTI TAB...');
        
        // Forza inizializzazione App se disponibile
        if (window.App && typeof window.App.init === 'function') {
          console.log('üì± Inizializzazione App...');
          window.App.init();
        }
        
        // Forza inizializzazione moduli principali
        if (window.Timeline && typeof window.Timeline.init === 'function') {
          console.log('‚è∞ Inizializzazione Timeline...');
          window.Timeline.init();
        }
        
        if (window.Clienti && typeof window.Clienti.init === 'function') {
          console.log('üë• Inizializzazione Clienti...');
          window.Clienti.init();
        }
        
        if (window.Percorsi && typeof window.Percorsi.init === 'function') {
          console.log('üõ£Ô∏è Inizializzazione Percorsi...');
          window.Percorsi.init();
        }
        
        if (window.Worksheet && typeof window.Worksheet.init === 'function') {
          console.log('üìä Inizializzazione Worksheet...');
          window.Worksheet.init();
        }
        
        if (window.DDTFT && typeof window.DDTFT.init === 'function') {
          console.log('üìÑ Inizializzazione DDTFT...');
          window.DDTFT.init();
        }
        
        if (window.DDTFTCore && typeof window.DDTFTCore.init === 'function') {
          console.log('üìÑ Inizializzazione DDTFTCore...');
          window.DDTFTCore.init();
        }
        
        if (window.ComandiModule && typeof window.ComandiModule.init === 'function') {
          console.log('‚öôÔ∏è Inizializzazione ComandiModule...');
          window.ComandiModule.init();
        }
        
        if (window.AIAssistant && typeof window.AIAssistant.init === 'function') {
          console.log('ü§ñ Inizializzazione AIAssistant...');
          window.AIAssistant.init();
        }
        
        if (window.FlavioAIAssistant && typeof window.FlavioAIAssistant.init === 'function') {
          console.log('üéØ Inizializzazione FlavioAIAssistant...');
          window.FlavioAIAssistant.init();
        }
        
        // üîÑ Il Middleware AI si auto-inizializza tramite DOMContentLoaded
        console.log('üîÑ Middleware AI: Auto-inizializzazione in corso...');
        
        // üé§ Inizializzazione SmartAssistant vocale
        if (window.SmartAssistant && typeof window.SmartAssistant.init === 'function') {
          console.log('üé§ Inizializzazione SmartAssistant...');
          window.SmartAssistant.init();
        }
        
        
        // Verifica cosa √® disponibile
        console.log('üîç Oggetti disponibili:', {
          App: typeof window.App,
          Timeline: typeof window.Timeline,
          Clienti: typeof window.Clienti,
          Percorsi: typeof window.Percorsi,
          Worksheet: typeof window.Worksheet,
          DDTFT: typeof window.DDTFT,
          DDTFTCore: typeof window.DDTFTCore,
          ComandiModule: typeof window.ComandiModule,
          AIAssistant: typeof window.AIAssistant,
          FlavioAIAssistant: typeof window.FlavioAIAssistant,
          GeminiAI: typeof window.GeminiAI,
          SmartAssistant: typeof window.SmartAssistant,
          VoiceAssistant: typeof window.VoiceAssistant,
          VoiceRecognition: typeof window.VoiceRecognition
        });
        
        console.log('‚úÖ CONTENUTI INIZIALIZZATI');
      }, 2000);
      
      
      // üß™ TEST FINALE: Verifica posizione tab demo statica
      window.testDemoTabStatic = () => {
        // ‚ùå RIMOSSO: Test posizione che causava monitoraggio inutile
      };
      
      // ‚ùå RIMOSSO: Auto-test rimosso
    })
    .catch(console.error);
  </script>
  
  <!-- Configurazione Supabase spostata in config/supabase-config.js -->
  
  <!-- ü§ñ PULSANTI FLOTTANTI AI VOCALI TRASCINABILI CON CONTROLLI AVANZATI -->
  <div id="floating-voice-container" class="floating-voice-container" style="display: flex;">
    
    <!-- Controlli principali -->
    <div class="main-voice-controls">
      <!-- Pulsante PUSH-TO-TALK per iPad -->
      <button id="floating-push-to-talk-btn" class="floating-mic-btn" title="Push-to-Talk (iPad)">
        üé§
      </button>
      
      <!-- Pulsante AI Assistant vocale (modalit√† automobile) -->
      <button id="floating-mic-btn" class="floating-mic-btn" title="Modalit√† automobile (ascolto continuo)">
        ü§ñ
      </button>
      
      <!-- Pulsanti modalit√† automobile AI separati -->
      <button id="floating-auto-on-btn" class="floating-mic-btn" title="Attiva modalit√† automobile AI" onclick="startAutoModeAI()" style="background: #34C759;">
        üöó ON
      </button>
      
      <button id="floating-auto-off-btn" class="floating-mic-btn" title="Disattiva modalit√† automobile AI" onclick="stopAutoModeAI()" style="background: #FF453A; display: none;">
        üöó OFF
      </button>
      
      <!-- Pulsante controlli avanzati -->
      <button id="floating-settings-btn" class="floating-mic-btn" title="Controlli avanzati" onclick="toggleAdvancedControls()">
        ‚öôÔ∏è
      </button>
      
      <!-- Pulsante stop risposta vocale AI -->
      <button id="floating-stop-btn" class="floating-mic-btn stop-btn-pulse" title="Ferma risposta vocale AI" onclick="stopAIVoiceResponse()" style="display: none; background: #FF453A;">
        ‚èπÔ∏è
      </button>
    </div>
    
    <!-- Status AI vocale -->
    <div id="floating-voice-status" class="floating-voice-status" style="display: none;">
      ü§ñ AI Assistant pronto
    </div>
    
    <!-- Pannello controlli avanzati -->
    <div id="voice-advanced-controls" class="voice-advanced-controls" style="display: none;">
      <div class="advanced-controls-header">
        <h4>üéõÔ∏è Controlli Vocali Avanzati</h4>
        <button onclick="toggleAdvancedControls()" style="background: none; border: none; font-size: 16px; cursor: pointer;">‚úï</button>
      </div>
      
      <!-- Volume TTS -->
      <div class="control-group">
        <label>üîä Volume Voce AI:</label>
        <input type="range" id="tts-volume" min="0" max="1" step="0.1" value="1" onchange="updateTTSVolume(this.value)">
        <span id="volume-display">100%</span>
      </div>
      
      <!-- Velocit√† TTS -->
      <div class="control-group">
        <label>‚ö° Velocit√† Voce AI:</label>
        <input type="range" id="tts-speed" min="0.5" max="2" step="0.1" value="0.9" onchange="updateTTSSpeed(this.value)">
        <span id="speed-display">0.9x</span>
      </div>
      
      <!-- Selezione voce -->
      <div class="control-group">
        <label>üó£Ô∏è Voce AI:</label>
        <select id="tts-voice" onchange="updateTTSVoice(this.value)">
          <option value="">Voce predefinita</option>
        </select>
      </div>
      
      <!-- Modalit√† riconoscimento -->
      <div class="control-group">
        <label>üé§ Modalit√† Riconoscimento:</label>
        <div style="display: flex; gap: 5px; flex-wrap: wrap;">
          <button onclick="setRecognitionMode('single')" class="mode-btn" data-mode="single">Singolo</button>
          <button onclick="setRecognitionMode('continuous')" class="mode-btn" data-mode="continuous">Continuo</button>
          <button onclick="setRecognitionMode('wakeword')" class="mode-btn active" data-mode="wakeword">Wake Word</button>
        </div>
      </div>
      
      <!-- Test audio -->
      <div class="control-group">
        <button onclick="testTTSVoice()" style="width: 100%; padding: 8px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
          üß™ Test Voce AI
        </button>
      </div>
      
      <!-- Reset impostazioni -->
      <div class="control-group">
        <button onclick="resetVoiceSettings()" style="width: 100%; padding: 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
          üîÑ Reset Impostazioni
        </button>
      </div>
    </div>
    
  </div>

  <script>
    // üé§ SISTEMA PULSANTI FLOTTANTI VOCALI
    let voiceControlsActive = false;
    let autoModeActive = false;
    let isCurrentlyListening = false;

    // Mostra i controlli vocali dopo il caricamento e inizializza drag & drop
    setTimeout(() => {
      const container = document.getElementById('floating-voice-container');
      console.log('üîç DEBUG: Container trovato:', container ? 'S√å' : 'NO');
      
      if (container) {
        container.style.display = 'flex';
        console.log('üîç DEBUG: Display impostato a flex');
        
        try {
          setupFloatingVoiceDragAndDrop(container);
          console.log('üîç DEBUG: Drag&Drop configurato');
        } catch (error) {
          console.error('‚ùå Errore setupFloatingVoiceDragAndDrop:', error);
        }
        
        try {
          loadSavedFloatingPosition(container);
          console.log('üîç DEBUG: Posizione caricata');
        } catch (error) {
          console.error('‚ùå Errore loadSavedFloatingPosition:', error);
        }
        
        console.log('üé§ Pulsanti vocali flottanti trascinabili attivati');
      } else {
        console.error('‚ùå Container floating-voice-container non trovato!');
      }
      
      // üì± Avvia monitoraggio per iPad
      try {
        startVoiceStateMonitoring();
        console.log('üîç DEBUG: Monitoraggio iPad avviato');
      } catch (error) {
        console.error('‚ùå Errore startVoiceStateMonitoring:', error);
      }
    }, 1000); // Riduco il timeout a 1 secondo

    // Gestione click pulsanti vocali
    document.addEventListener('DOMContentLoaded', () => {
      const micBtn = document.getElementById('floating-mic-btn');
      const pushToTalkBtn = document.getElementById('floating-push-to-talk-btn');
      const autoOnBtn = document.getElementById('floating-auto-on-btn');
      const autoOffBtn = document.getElementById('floating-auto-off-btn');
      const stopBtn = document.getElementById('floating-stop-btn');
      const status = document.getElementById('floating-voice-status');

      // üé§ NUOVO PULSANTE PUSH-TO-TALK per iPad
      if (pushToTalkBtn) {
        pushToTalkBtn.addEventListener('click', () => {
          console.log('üé§ Click pulsante push-to-talk');
          togglePushToTalkRecognition();
        });
      }

      // ü§ñ PULSANTE MODALIT√Ä AUTOMOBILE (ascolto continuo)
      if (micBtn) {
        micBtn.addEventListener('click', () => {
          console.log('ü§ñ Click pulsante modalit√† automobile');
          toggleContinuousMode();
        });
      }

      // üì± LISTENER PER IPAD - Aggiorna pulsante quando il riconoscimento termina
      window.addEventListener('voicerecognition:end', () => {
        const isIPad = /iPad/.test(navigator.userAgent) || localStorage.getItem('force_ipad_mode') === 'true';
        if (isIPad && autoModeType === 'off') {
          console.log('üì± iPad: Riconoscimento terminato - aggiorno pulsante');
          isCurrentlyListening = false;
          updateFloatingUI();
        }
      });

      // üì± LISTENER PER IPAD - Aggiorna pulsante quando il riconoscimento inizia
      window.addEventListener('voicerecognition:start', () => {
        const isIPad = /iPad/.test(navigator.userAgent) || localStorage.getItem('force_ipad_mode') === 'true';
        if (isIPad && autoModeType === 'off') {
          console.log('üì± iPad: Riconoscimento iniziato - aggiorno pulsante');
          isCurrentlyListening = true;
          updateFloatingUI();
        }
      });

      // üì± LISTENER PER PUSH-TO-TALK - Aggiorna pulsante quando il riconoscimento termina
      window.addEventListener('voicerecognition:end', () => {
        if (isPushToTalkActive) {
          console.log('üé§ Push-to-Talk: Riconoscimento terminato - fermo automaticamente');
          stopPushToTalkRecognition();
        }
      });

      // üîç DEBUG: Verifica pulsanti vocali
      console.log('üîç DEBUG: Pulsanti vocali trovati:', {
        micBtn: micBtn ? 'S√å' : 'NO',
        pushToTalkBtn: pushToTalkBtn ? 'S√å' : 'NO',
        autoOnBtn: autoOnBtn ? 'S√å' : 'NO',
        autoOffBtn: autoOffBtn ? 'S√å' : 'NO',
        stopBtn: stopBtn ? 'S√å' : 'NO',
        status: status ? 'S√å' : 'NO'
      });

      if (autoOnBtn) {
        autoOnBtn.addEventListener('click', () => {
          console.log('üöó Click AUTO ON');
          startAutoModeAI();
        });
      }

      if (autoOffBtn) {
        autoOffBtn.addEventListener('click', () => {
          console.log('üöó Click AUTO OFF');
          stopAutoModeAI();
        });
      }

      if (stopBtn) {
        stopBtn.addEventListener('click', () => {
          console.log('‚èπÔ∏è Click STOP risposta vocale');
          stopAIVoiceResponse();
        });
      }
    });

    // üéØ SISTEMA DRAG & DROP PER PULSANTI FLOTTANTI VOCALI
    function setupFloatingVoiceDragAndDrop(container) {
      let isDragging = false;
      let startX, startY, initialX, initialY;
      let dragTimeout = null;

      console.log('üéØ Setup drag & drop per controlli vocali flottanti...');

      // Mouse events per desktop
      container.addEventListener('mousedown', (e) => {
        // Solo drag se si clicca sul container ma non sui pulsanti
        if (e.target.closest('.floating-mic-btn')) return;
        
        isDragging = true;
        container.classList.add('dragging');
        
        startX = e.clientX;
        startY = e.clientY;
        
        const rect = container.getBoundingClientRect();
        initialX = rect.left;
        initialY = rect.top;
        
        container.style.transition = 'none';
        
        e.preventDefault();
        console.log('üñ±Ô∏è Inizio drag mouse');
      });

      document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        
        e.preventDefault();
        
        const deltaX = e.clientX - startX;
        const deltaY = e.clientY - startY;
        
        const newX = initialX + deltaX;
        const newY = initialY + deltaY;
        
        updateFloatingPosition(container, newX, newY);
      });

      document.addEventListener('mouseup', () => {
        if (isDragging) {
          isDragging = false;
          container.classList.remove('dragging');
          container.style.transition = 'all 0.3s ease';
          saveFloatingPosition(container);
          console.log('üñ±Ô∏è Fine drag mouse');
        }
      });

      // Touch events per tablet/mobile
      container.addEventListener('touchstart', (e) => {
        // Solo drag se si clicca sul container ma non sui pulsanti
        if (e.target.closest('.floating-mic-btn')) return;
        
        isDragging = true;
        const touch = e.touches[0];
        startX = touch.clientX;
        startY = touch.clientY;
        
        const rect = container.getBoundingClientRect();
        initialX = rect.left;
        initialY = rect.top;
        
        container.style.transition = 'none';
        container.style.opacity = '0.8';
        container.classList.add('dragging');
        
        e.preventDefault();
        console.log('üëÜ Inizio drag touch');
      }, { passive: false });

      container.addEventListener('touchmove', (e) => {
        if (!isDragging) return;
        
        e.preventDefault();
        
        const touch = e.touches[0];
        const deltaX = touch.clientX - startX;
        const deltaY = touch.clientY - startY;
        
        const newX = initialX + deltaX;
        const newY = initialY + deltaY;
        
        updateFloatingPosition(container, newX, newY);
      }, { passive: false });

      container.addEventListener('touchend', () => {
        if (isDragging) {
          isDragging = false;
          container.classList.remove('dragging');
          container.style.transition = 'all 0.3s ease';
          container.style.opacity = '1';
          saveFloatingPosition(container);
          console.log('üëÜ Fine drag touch');
        }
      });
    }

    // Aggiorna posizione con vincoli di schermo
    function updateFloatingPosition(container, left, top) {
      const maxX = window.innerWidth - container.offsetWidth;
      const maxY = window.innerHeight - container.offsetHeight;
      
      const constrainedX = Math.max(0, Math.min(maxX, left));
      const constrainedY = Math.max(0, Math.min(maxY, top));
      
      container.style.left = constrainedX + 'px';
      container.style.top = constrainedY + 'px';
      container.style.right = 'auto';
      container.style.bottom = 'auto';
    }

    // Salva posizione in localStorage
    function saveFloatingPosition(container) {
      const rect = container.getBoundingClientRect();
      const position = {
        left: rect.left,
        top: rect.top
      };
      localStorage.setItem('floatingVoicePosition', JSON.stringify(position));
      console.log('üíæ Posizione pulsanti vocali salvata:', position);
    }

    // Carica posizione salvata
    function loadSavedFloatingPosition(container) {
      try {
        const saved = localStorage.getItem('floatingVoicePosition');
        if (saved) {
          const position = JSON.parse(saved);
          updateFloatingPosition(container, position.left, position.top);
          console.log('üìç Posizione pulsanti vocali ripristinata:', position);
        }
      } catch (error) {
        console.log('‚ö†Ô∏è Errore caricamento posizione:', error);
      }
    }

    // ü§ñ SISTEMA AI VOCALE INTEGRATO - Comunicazione bidirezionale con AI Assistant
    function toggleVoiceRecognition() {
      if (isCurrentlyListening) {
        stopAIVoiceRecognition();
      } else {
        startAIVoiceRecognition();
      }
    }

    // üé§ NUOVO SISTEMA PUSH-TO-TALK per iPad
    let isPushToTalkActive = false;
    
    function togglePushToTalkRecognition() {
      if (isPushToTalkActive) {
        stopPushToTalkRecognition();
      } else {
        startPushToTalkRecognition();
      }
    }

    function startPushToTalkRecognition() {
      console.log('üé§ Avvio Push-to-Talk...');
      
      if (window.VoiceRecognition && typeof window.VoiceRecognition.start === 'function') {
        // Configura per modalit√† singola (NON continua)
        if (window.VoiceRecognition.engine) {
          window.VoiceRecognition.engine.continuous = false;
          window.VoiceRecognition.engine.interimResults = true;
        }
        
        // üîä SISTEMA ORIGINALE: Niente flag complicate
        
        window.VoiceRecognition.start();
        isPushToTalkActive = true;
        updatePushToTalkUI();
        showFloatingStatus('üé§ Push-to-Talk attivo');
      } else {
        console.error('‚ùå VoiceRecognition non disponibile');
        showFloatingStatus('‚ùå Sistema vocale non disponibile');
      }
    }

    function stopPushToTalkRecognition() {
      console.log('üé§ Stop Push-to-Talk...');
      
      if (window.VoiceRecognition && typeof window.VoiceRecognition.stop === 'function') {
        window.VoiceRecognition.stop();
      }
      
      // üîä SISTEMA ORIGINALE: Niente flag da rimuovere
      
      isPushToTalkActive = false;
      updatePushToTalkUI();
      showFloatingStatus('üé§ Push-to-Talk disattivato');
    }

    // ü§ñ MODALIT√Ä AUTOMOBILE (ascolto continuo)
    let isContinuousModeActive = false;
    
    function toggleContinuousMode() {
      if (isContinuousModeActive) {
        stopContinuousMode();
      } else {
        startContinuousMode();
      }
    }

    function startContinuousMode() {
      console.log('ü§ñ Avvio modalit√† automobile...');
      
      if (window.VoiceRecognition && typeof window.VoiceRecognition.start === 'function') {
        // Configura per modalit√† continua
        if (window.VoiceRecognition.engine) {
          window.VoiceRecognition.engine.continuous = true;
          window.VoiceRecognition.engine.interimResults = true;
        }
        
        window.VoiceRecognition.start();
        isContinuousModeActive = true;
        updateContinuousModeUI();
        showFloatingStatus('ü§ñ Modalit√† automobile attiva');
      } else {
        console.error('‚ùå VoiceRecognition non disponibile');
        showFloatingStatus('‚ùå Sistema vocale non disponibile');
      }
    }

    function stopContinuousMode() {
      console.log('ü§ñ Stop modalit√† automobile...');
      
      if (window.VoiceRecognition && typeof window.VoiceRecognition.stop === 'function') {
        window.VoiceRecognition.stop();
      }
      
      isContinuousModeActive = false;
      updateContinuousModeUI();
      showFloatingStatus('ü§ñ Modalit√† automobile disattivata');
    }

    // üõë FERMA RICONOSCIMENTO VOCALE GLOBALMENTE (chiamato dall'AI durante TTS)
    window.stopAllVoiceRecognitionGlobal = function() {
      console.log('üõë Stop vocale durante TTS - modalit√† auto:', autoModeType);
      
      // Ferma tutti i sistemi vocali temporaneamente
      if (window.VoiceRecognition && typeof window.VoiceRecognition.stop === 'function') {
        window.VoiceRecognition.stop();
      }
      
      if (window.AIVoiceManager && typeof window.AIVoiceManager.stopListening === 'function') {
        window.AIVoiceManager.stopListening();
      }
      
      if (window.AIVoiceManagerV2 && typeof window.AIVoiceManagerV2.stopListening === 'function') {
        window.AIVoiceManagerV2.stopListening();
      }
      
      if (window.VoiceAssistant && typeof window.VoiceAssistant.stopListening === 'function') {
        window.VoiceAssistant.stopListening();
      }
      
      // Aggiorna stato UI solo per modalit√† singola
      if (autoModeType === 'off') {
        isCurrentlyListening = false;
        updateFloatingUI();
      }
      
      // Le modalit√† automobile si riavvieranno automaticamente dopo la risposta
      console.log('üõë Sistemi vocali fermati temporaneamente durante TTS');
    };

    // Avvia riconoscimento vocale AI integrato
    function startAIVoiceRecognition() {
      console.log('ü§ñ Avvio riconoscimento vocale AI integrato...');
      
      // Prima priorit√†: Sistema VoiceRecognition integrato con AI
      if (window.VoiceRecognition && typeof window.VoiceRecognition.start === 'function') {
        console.log('üé§ Utilizzo VoiceRecognition integrato con AI');
        window.VoiceRecognition.start();
        isCurrentlyListening = true;
        updateFloatingUI();
        showFloatingStatus('ü§ñ In ascolto per AI...');
        return;
      }

      // Fallback: AIVoiceManager
      if (window.AIVoiceManager && typeof window.AIVoiceManager.startListening === 'function') {
        console.log('üéôÔ∏è Utilizzo AIVoiceManager');
        window.AIVoiceManager.startListening();
        isCurrentlyListening = true;
        updateFloatingUI();
        showFloatingStatus('üéôÔ∏è AIVoiceManager attivo...');
        return;
      }

      // Fallback: VoiceAssistant base
      if (window.VoiceAssistant && typeof window.VoiceAssistant.startListening === 'function') {
        console.log('üé§ Utilizzo VoiceAssistant base');
        window.VoiceAssistant.startListening();
        isCurrentlyListening = true;
        updateFloatingUI();
        showFloatingStatus('üé§ VoiceAssistant attivo...');
        return;
      }

      // Nessun sistema disponibile
      console.warn('‚ö†Ô∏è Nessun sistema vocale AI disponibile');
      showFloatingStatus('‚ùå Sistema vocale non pronto');
    }

    // Stop riconoscimento vocale AI
    function stopAIVoiceRecognition() {
      console.log('üõë Stop riconoscimento vocale AI');
      
      // Ferma tutti i sistemi vocali
      if (window.VoiceRecognition && typeof window.VoiceRecognition.stop === 'function') {
        window.VoiceRecognition.stop();
      }
      
      if (window.AIVoiceManager && typeof window.AIVoiceManager.stopListening === 'function') {
        window.AIVoiceManager.stopListening();
      }
      
      if (window.VoiceAssistant && typeof window.VoiceAssistant.stopListening === 'function') {
        window.VoiceAssistant.stopListening();
      }
      
      isCurrentlyListening = false;
      updateFloatingUI();
      showFloatingStatus('üõë Riconoscimento fermato');
    }

    // üöó MODALIT√Ä AUTOMOBILE AI - Wake word "Hey Assistente" + Ascolto continuo
    let autoModeType = 'off'; // 'off', 'wakeword', 'continuous'
    
    // Funzione per avviare modalit√† automobile
    function startAutoModeAI() {
      autoModeType = 'continuous'; // Modalit√† continua diretta
      autoModeActive = true;
      console.log('üöó Modalit√† automobile: ATTIVATA (continua)');
      startAutoModeContinuous();
      updateAutoModeUI();
    }
    
    // Funzione originale per compatibilit√†
    function toggleAutoMode() {
      // Cicla tra: OFF ‚Üí Wake Word ‚Üí Continuo ‚Üí OFF
      if (autoModeType === 'off') {
        autoModeType = 'wakeword';
        autoModeActive = true;
        console.log('üöó Modalit√† automobile: WAKE WORD attivata');
        startAutoModeWakeWord();
      } else if (autoModeType === 'wakeword') {
        autoModeType = 'continuous';
        console.log('üöó Modalit√† automobile: ASCOLTO CONTINUO attivato');
        startAutoModeContinuous();
      } else {
        autoModeType = 'off';
        autoModeActive = false;
        console.log('üöó Modalit√† automobile: OFF');
        stopAutoModeAI();
      }
      
      updateFloatingUI();
    }

    // üé® AGGIORNA UI PULSANTI AUTOMOBILE
    function updateAutoModeUI() {
      const autoOnBtn = document.getElementById('floating-auto-on-btn');
      const autoOffBtn = document.getElementById('floating-auto-off-btn');
      
      if (autoModeType === 'off') {
        if (autoOnBtn) autoOnBtn.style.display = 'block';
        if (autoOffBtn) autoOffBtn.style.display = 'none';
        showFloatingStatus('üöó Modalit√† automobile: OFF');
      } else {
        if (autoOnBtn) autoOnBtn.style.display = 'none';
        if (autoOffBtn) autoOffBtn.style.display = 'block';
        showFloatingStatus('üöó Modalit√† automobile: ON');
      }
    }

    // üéØ WAKE WORD MODE - "Hey Assistente" (Simulato con riconoscimento continuo)
    function startAutoModeWakeWord() {
      console.log('üöó Avvio modalit√† WAKE WORD simulata: "Hey Assistente"...');
      
      // Modalit√† simulata: riconoscimento continuo che ascolta "Hey Assistente"
      if (window.VoiceRecognition && typeof window.VoiceRecognition.start === 'function') {
        console.log('üé§ Simulazione wake word con VoiceRecognition continuo...');
        
        // Configura riconoscimento continuo per wake word
        if (window.VoiceRecognition.engine) {
          window.VoiceRecognition.engine.continuous = true;
          window.VoiceRecognition.engine.interimResults = true;
        }
        
        // Avvia listener per wake word - SOLO risultati finali per evitare duplicati
        window.addEventListener('voicerecognition:final', handleWakeWordDetection);
        // Rimosso interim per evitare richieste multiple durante il parlato
        
        window.VoiceRecognition.start();
        showFloatingStatus('üöó "Hey Assistente" attivo (simulato)');
        setupWakeWordRestart();
        return;
      }

      // Fallback: AIVoiceManager per dispositivi compatibili
      if (window.AIVoiceManager && typeof window.AIVoiceManager.initForIPhone === 'function') {
        console.log('üéôÔ∏è Tentativo AIVoiceManager...');
        const success = window.AIVoiceManager.initForIPhone();
        if (success && typeof window.AIVoiceManager.startWakeWordDetection === 'function') {
          window.AIVoiceManager.startWakeWordDetection();
          showFloatingStatus('üöó "Hey Assistente" attivo');
          return;
        }
      }

      console.warn('‚ö†Ô∏è Wake word non supportato su questo dispositivo');
      showFloatingStatus('‚ùå Wake word non disponibile');
      autoModeType = 'off';
      autoModeActive = false;
    }

    // üéØ GESTIONE WAKE WORD DETECTION
    let lastWakeWordTime = 0;
    let lastProcessedCommand = '';
    
    function handleWakeWordDetection(event) {
      const transcript = event.detail.transcript?.toLowerCase() || '';
      const currentTime = Date.now();
      
      // Debouncing: evita richieste duplicate entro 3 secondi
      if (currentTime - lastWakeWordTime < 3000) {
        return;
      }
      
      // Cerca varianti di "hey assistente"
      const wakeWords = ['hey assistente', 'ehi assistente', 'ey assistente', 'assistente'];
      const foundWakeWord = wakeWords.find(word => transcript.includes(word));
      
      if (foundWakeWord) {
        console.log('üöó Wake word rilevato:', foundWakeWord);
        
        // Estrai il comando dopo la wake word
        const commandStart = transcript.indexOf(foundWakeWord) + foundWakeWord.length;
        const command = transcript.substring(commandStart).trim();
        
        if (command && command.length > 2) {
          // Evita comandi duplicati
          if (command === lastProcessedCommand) {
            console.log('üîÑ Comando duplicato ignorato:', command);
            return;
          }
          
          console.log('üé§ Comando estratto:', command);
          showFloatingStatus('üé§ Comando rilevato...');
          
          // Aggiorna tracking
          lastWakeWordTime = currentTime;
          lastProcessedCommand = command;
          
          // Invia il comando all'AI
          if (window.FlavioAIAssistant && typeof window.FlavioAIAssistant.processVoiceInput === 'function') {
            window.FlavioAIAssistant.processVoiceInput(command);
          }
        } else {
          // Solo wake word senza comando
          showFloatingStatus('üé§ Ti ascolto...');
          lastWakeWordTime = currentTime;
        }
      }
    }

    // Setup restart automatico per wake word
    function setupWakeWordRestart() {
      if (autoModeType !== 'wakeword') return;
      
      window.wakeWordRestartListener = () => {
        if (autoModeType === 'wakeword') {
          console.log('üîÑ Riavvio wake word detection...');
          setTimeout(() => {
            if (autoModeType === 'wakeword' && window.VoiceRecognition) {
              window.VoiceRecognition.start();
            }
          }, 1000);
        }
      };
      
      window.addEventListener('voicerecognition:end', window.wakeWordRestartListener);
    }

    // üîÑ CONTINUOUS MODE - Ascolto continuo senza wake word
    function startAutoModeContinuous() {
      console.log('üöó Avvio modalit√† ASCOLTO CONTINUO...');
      
      // Prima priorit√†: VoiceRecognition per ascolto continuo
      if (window.VoiceRecognition && typeof window.VoiceRecognition.start === 'function') {
        console.log('üé§ Attivazione VoiceRecognition continuo...');
        
        // Configura per ascolto continuo
        if (window.VoiceRecognition.engine) {
          window.VoiceRecognition.engine.continuous = true;
          window.VoiceRecognition.engine.interimResults = true;
        }
        
        window.VoiceRecognition.start();
        showFloatingStatus('üîÑ Ascolto continuo attivo');
        
        // Auto-riavvia se si ferma
        setupContinuousRestart();
        return;
      }

      // Fallback: AIVoiceManager in modalit√† continua
      if (window.AIVoiceManager && typeof window.AIVoiceManager.startListening === 'function') {
        console.log('üéôÔ∏è AIVoiceManager modalit√† continua...');
        window.AIVoiceManager.startListening();
        showFloatingStatus('üîÑ AI ascolto continuo');
        return;
      }

      console.warn('‚ö†Ô∏è Ascolto continuo non supportato');
      showFloatingStatus('‚ùå Continuo non disponibile');
      autoModeType = 'off';
      autoModeActive = false;
    }

    // Auto-riavvia per modalit√† continua
    function setupContinuousRestart() {
      if (autoModeType !== 'continuous') return;
      
      // Listener per riavvio automatico
      const restartListener = () => {
        if (autoModeType === 'continuous') {
          console.log('üîÑ Riavvio ascolto continuo...');
          setTimeout(() => {
            if (autoModeType === 'continuous' && window.VoiceRecognition) {
              window.VoiceRecognition.start();
            }
          }, 1000);
        }
      };
      
      // Aggiungi listener per restart automatico
      window.addEventListener('voicerecognition:end', restartListener);
      
      // Cleanup quando si disattiva
      window.autoModeRestartListener = restartListener;
    }

    // Ferma modalit√† automobile AI
    function stopAutoModeAI() {
      console.log('üõë Stop modalit√† automobile AI');
      
      // Rimuovi listener di restart continuo
      if (window.autoModeRestartListener) {
        window.removeEventListener('voicerecognition:end', window.autoModeRestartListener);
        window.autoModeRestartListener = null;
      }
      
      // Rimuovi listener wake word
      if (window.wakeWordRestartListener) {
        window.removeEventListener('voicerecognition:end', window.wakeWordRestartListener);
        window.wakeWordRestartListener = null;
      }
      
      // Rimuovi listener wake word detection
      window.removeEventListener('voicerecognition:final', handleWakeWordDetection);
      window.removeEventListener('voicerecognition:interim', handleWakeWordDetection);
      
      // Reset variabili di debouncing
      lastWakeWordTime = 0;
      lastProcessedCommand = '';
      
      // Ferma tutti i sistemi vocali
      if (window.AIVoiceManager) {
        if (typeof window.AIVoiceManager.stopWakeWordDetection === 'function') {
          window.AIVoiceManager.stopWakeWordDetection();
        }
        if (typeof window.AIVoiceManager.stopListening === 'function') {
          window.AIVoiceManager.stopListening();
        }
      }
      
      if (window.AIVoiceManagerV2 && typeof window.AIVoiceManagerV2.stopListening === 'function') {
        window.AIVoiceManagerV2.stopListening();
      }
      
      if (window.VoiceRecognition && typeof window.VoiceRecognition.stop === 'function') {
        window.VoiceRecognition.stop();
      }
      
      // Reset stato e aggiorna UI
      autoModeType = 'off';
      autoModeActive = false;
      updateAutoModeUI();
      showFloatingStatus('üõë Modalit√† auto OFF');
    }

    // Aggiorna UI pulsanti AI vocali
    function updateFloatingUI() {
      const micBtn = document.getElementById('floating-mic-btn');
      
      if (micBtn) {
        if (isCurrentlyListening) {
          micBtn.classList.add('listening');
          micBtn.textContent = 'üõë';
          micBtn.title = 'Stop riconoscimento AI vocale';
          showFloatingStatus('ü§ñ AI in ascolto...');
        } else {
          micBtn.classList.remove('listening');
          micBtn.textContent = 'ü§ñ';
          micBtn.title = 'Parla con AI Assistant';
          
          if (autoModeType === 'off') {
            showFloatingStatus('ü§ñ Pronto per AI');
          }
        }
      }
    }

    // üé§ Aggiorna UI pulsante Push-to-Talk
    function updatePushToTalkUI() {
      const pushToTalkBtn = document.getElementById('floating-push-to-talk-btn');
      
      if (pushToTalkBtn) {
        if (isPushToTalkActive) {
          pushToTalkBtn.classList.add('listening');
          pushToTalkBtn.textContent = 'üõë';
          pushToTalkBtn.title = 'Stop Push-to-Talk';
          pushToTalkBtn.style.background = 'linear-gradient(135deg, #f44336, #d32f2f)';
        } else {
          pushToTalkBtn.classList.remove('listening');
          pushToTalkBtn.textContent = 'üé§';
          pushToTalkBtn.title = 'Push-to-Talk (iPad)';
          pushToTalkBtn.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
        }
      }
    }

    // ü§ñ Aggiorna UI pulsante modalit√† automobile
    function updateContinuousModeUI() {
      const micBtn = document.getElementById('floating-mic-btn');
      
      if (micBtn) {
        if (isContinuousModeActive) {
          micBtn.classList.add('listening', 'auto-mode');
          micBtn.textContent = 'üõë';
          micBtn.title = 'Stop modalit√† automobile';
          micBtn.style.background = 'linear-gradient(135deg, #00b894, #00a085)';
        } else {
          micBtn.classList.remove('listening', 'auto-mode');
          micBtn.textContent = 'ü§ñ';
          micBtn.title = 'Modalit√† automobile (ascolto continuo)';
          micBtn.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
        }
      }
    }

    // üì± MONITORAGGIO CONTINUO STATO VOCALE PER IPAD
    function startVoiceStateMonitoring() {
      const isIPad = /iPad/.test(navigator.userAgent) || localStorage.getItem('force_ipad_mode') === 'true';
      
      if (isIPad) {
        console.log('üì± iPad: Avvio monitoraggio stato vocale');
        
        setInterval(() => {
          // Controlla stato reale del sistema VoiceRecognition
          let actualListening = false;
          
          if (window.VoiceRecognition) {
            actualListening = window.VoiceRecognition.isActive || window.VoiceRecognition.isListening();
          }
          
          // Se lo stato √® diverso da quello che pensiamo, correggi
          if (actualListening !== isCurrentlyListening && autoModeType === 'off') {
            console.log(`üì± iPad: Correzione stato - era ${isCurrentlyListening}, ora ${actualListening}`);
            isCurrentlyListening = actualListening;
            updateFloatingUI();
          }
        }, 500); // Controlla ogni mezzo secondo
      }
    }

    // Mostra status
    function showFloatingStatus(message) {
      const status = document.getElementById('floating-voice-status');
      if (status) {
        status.textContent = message;
        status.style.display = 'block';
        
        // Nascondi dopo 3 secondi
        setTimeout(() => {
          status.style.display = 'none';
        }, 3000);
      }
    }

    // üõë FERMA RISPOSTA VOCALE AI IMMEDIATAMENTE
    function stopAIVoiceResponse() {
      console.log('üõë Stop immediato risposta vocale AI');
      
      // Ferma immediatamente la sintesi vocale
      if (window.speechSynthesis) {
        window.speechSynthesis.cancel();
        console.log('üõë Sintesi vocale cancellata');
      }
      
      // Nascondi pulsante di stop
      const stopBtn = document.getElementById('floating-stop-btn');
      if (stopBtn) {
        stopBtn.style.display = 'none';
      }
      
      // Aggiorna status
      showFloatingStatus('‚èπÔ∏è Risposta vocale fermata');
      
      // Riattiva riconoscimento se in modalit√† automobile
      if (autoModeType === 'wakeword') {
        setTimeout(() => {
          if (autoModeType === 'wakeword' && window.VoiceRecognition) {
            window.VoiceRecognition.start();
            showFloatingStatus('üöó "Hey Assistente" attivo');
          }
        }, 500);
      } else if (autoModeType === 'continuous') {
        setTimeout(() => {
          if (autoModeType === 'continuous' && window.VoiceRecognition) {
            window.VoiceRecognition.start();
            showFloatingStatus('üîÑ Ascolto continuo attivo');
          }
        }, 500);
      }
    }

    // üéõÔ∏è SISTEMA CONTROLLI AVANZATI VOCALI - GLOBALE
    window.currentTTSSettings = {
      volume: 1.0,
      rate: 0.9,
      voice: null
    };

    // Toggle pannello controlli avanzati
    function toggleAdvancedControls() {
      const panel = document.getElementById('voice-advanced-controls');
      if (panel) {
        if (panel.style.display === 'none' || !panel.style.display) {
          panel.style.display = 'block';
          initializeAdvancedControls();
          showFloatingStatus('‚öôÔ∏è Controlli avanzati aperti');
        } else {
          panel.style.display = 'none';
          showFloatingStatus('‚öôÔ∏è Controlli avanzati chiusi');
        }
      }
    }

    // Inizializza controlli avanzati
    function initializeAdvancedControls() {
      // Popola select delle voci
      populateVoiceSelect();
      
      // Aggiorna display valori
      updateVolumeDisplay();
      updateSpeedDisplay();
      
      console.log('‚öôÔ∏è Controlli avanzati inizializzati');
    }

    // Popola select con voci disponibili
    function populateVoiceSelect() {
      const select = document.getElementById('tts-voice');
      if (!select) return;
      
      const voices = speechSynthesis.getVoices();
      select.innerHTML = '<option value="">Voce predefinita</option>';
      
      // Filtra voci italiane prima
      const italianVoices = voices.filter(voice => voice.lang.includes('it'));
      italianVoices.forEach(voice => {
        const option = document.createElement('option');
        option.value = voice.name;
        option.textContent = `üáÆüáπ ${voice.name} (${voice.lang})`;
        select.appendChild(option);
      });
      
      // Aggiungi altre voci
      const otherVoices = voices.filter(voice => !voice.lang.includes('it'));
      otherVoices.forEach(voice => {
        const option = document.createElement('option');
        option.value = voice.name;
        option.textContent = `${voice.name} (${voice.lang})`;
        select.appendChild(option);
      });
      
      console.log(`üó£Ô∏è Caricate ${voices.length} voci (${italianVoices.length} italiane)`);
    }

    // Aggiorna volume TTS
    function updateTTSVolume(value) {
      window.currentTTSSettings.volume = parseFloat(value);
      updateVolumeDisplay();
      console.log('üîä Volume TTS aggiornato:', window.currentTTSSettings.volume);
    }

    // Aggiorna velocit√† TTS
    function updateTTSSpeed(value) {
      window.currentTTSSettings.rate = parseFloat(value);
      updateSpeedDisplay();
      console.log('‚ö° Velocit√† TTS aggiornata:', window.currentTTSSettings.rate);
    }

    // Aggiorna voce TTS
    function updateTTSVoice(voiceName) {
      const voices = speechSynthesis.getVoices();
      window.currentTTSSettings.voice = voices.find(voice => voice.name === voiceName) || null;
      console.log('üó£Ô∏è Voce TTS selezionata:', voiceName);
    }

    // Test voce TTS
    function testTTSVoice() {
      const testText = "Ciao! Sono la voce dell'AI Assistant. Volume e velocit√† configurati correttamente.";
      
      try {
        speechSynthesis.cancel(); // Ferma eventuali speech in corso
        
        const utterance = new SpeechSynthesisUtterance(testText);
        utterance.lang = 'it-IT';
        utterance.volume = window.currentTTSSettings.volume;
        utterance.rate = window.currentTTSSettings.rate;
        
        if (window.currentTTSSettings.voice) {
          utterance.voice = window.currentTTSSettings.voice;
        }
        
        utterance.onstart = () => showFloatingStatus('üß™ Test voce in corso...');
        utterance.onend = () => showFloatingStatus('‚úÖ Test voce completato');
        utterance.onerror = () => showFloatingStatus('‚ùå Errore test voce');
        
        speechSynthesis.speak(utterance);
        
      } catch (error) {
        console.error('‚ùå Errore test TTS:', error);
        showFloatingStatus('‚ùå Errore test voce');
      }
    }

    // Imposta modalit√† riconoscimento
    function setRecognitionMode(mode) {
      // Aggiorna UI pulsanti modalit√†
      document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      const activeBtn = document.querySelector(`[data-mode="${mode}"]`);
      if (activeBtn) {
        activeBtn.classList.add('active');
      }
      
      // Applica modalit√†
      switch(mode) {
        case 'single':
          if (autoModeType !== 'off') {
            autoModeType = 'off';
            autoModeActive = false;
            stopAutoModeAI();
          }
          showFloatingStatus('üé§ Modalit√†: Singolo click');
          break;
          
        case 'continuous':
          autoModeType = 'continuous';
          autoModeActive = true;
          startAutoModeContinuous();
          showFloatingStatus('üîÑ Modalit√†: Ascolto continuo');
          break;
          
        case 'wakeword':
          autoModeType = 'wakeword';
          autoModeActive = true;
          startAutoModeWakeWord();
          showFloatingStatus('üöó Modalit√†: Wake Word');
          break;
      }
      
      updateFloatingUI();
      console.log(`üéõÔ∏è Modalit√† riconoscimento: ${mode}`);
    }

    // Reset impostazioni vocali
    function resetVoiceSettings() {
      // Reset valori predefiniti
      window.currentTTSSettings = {
        volume: 1.0,
        rate: 0.9,
        voice: null
      };
      
      // Reset UI
      document.getElementById('tts-volume').value = 1.0;
      document.getElementById('tts-speed').value = 0.9;
      document.getElementById('tts-voice').value = '';
      
      // Reset modalit√†
      setRecognitionMode('wakeword');
      
      // Aggiorna display
      updateVolumeDisplay();
      updateSpeedDisplay();
      
      showFloatingStatus('üîÑ Impostazioni reset');
      console.log('üîÑ Impostazioni vocali resettate');
    }

    // Aggiorna display volume
    function updateVolumeDisplay() {
      const display = document.getElementById('volume-display');
      if (display) {
        display.textContent = Math.round(window.currentTTSSettings.volume * 100) + '%';
      }
    }

    // Aggiorna display velocit√†
    function updateSpeedDisplay() {
      const display = document.getElementById('speed-display');
      if (display) {
        display.textContent = window.currentTTSSettings.rate + 'x';
      }
    }

    // Inizializza voci quando disponibili
    if (speechSynthesis.getVoices().length === 0) {
      speechSynthesis.onvoiceschanged = () => {
        const panel = document.getElementById('voice-advanced-controls');
        if (panel && panel.style.display === 'block') {
          populateVoiceSelect();
        }
      };
    }

    // Export functions globally
    window.toggleVoiceRecognition = toggleVoiceRecognition;
    window.toggleAutoMode = toggleAutoMode;
    window.showFloatingStatus = showFloatingStatus;
    window.toggleAdvancedControls = toggleAdvancedControls;
    window.updateTTSVolume = updateTTSVolume;
    window.updateTTSSpeed = updateTTSSpeed;
    window.updateTTSVoice = updateTTSVoice;
    window.testTTSVoice = testTTSVoice;
    window.setRecognitionMode = setRecognitionMode;
    window.resetVoiceSettings = resetVoiceSettings;

  </script>

  <!-- Fix conteggio clienti -->
  <script src="fix-client-count-final.js"></script>

</body>
</html>
